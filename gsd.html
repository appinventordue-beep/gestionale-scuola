<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Assenze Docenti</title>
    <!-- Importa Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importa la font Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <!-- Importa Firebase SDK -->
    <script type="module">
        // Importa le funzioni di cui hai bisogno
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Rendi le funzioni/variabili accessibili globalmente
        // Questo ci permette di usarle nello script non-module qui sotto
        window.firebase = {
            initializeApp,
            getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, deleteDoc, setLogLevel
        };
    </script>
    
    <style>
        /* Stile base con la font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Stili per la tabella "sticky header" */
        .table-container {
            max-height: 60vh; /* Altezza massima per la tabella settimanale */
            overflow-y: auto;
        }
        .daily-table-container {
            max-height: 70vh; /* Altezza massima per la tabella giornaliera */
            overflow-y: auto;
        }
        th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Input per permessi brevi (ex checkbox) */
        .absence-input {
            transition: all 0.2s ease;
        }
        .absence-input:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }

        /* Colori di sfondo per la motivazione */
        .bg-yellow-50 { background-color: #fffbeb; } /* Giallo Chiaro per Compresenza */
        .bg-blue-50 { background-color: #eff6ff; } /* Azzurro Chiaro per Docente Classe */
        .bg-orange-50 { background-color: #fff7ed; } /* Arancione Chiaro per Stessa Materia */
        .bg-green-50 { background-color: #f0fdf4; } /* Verde Chiaro per Disponibilità */
        .bg-red-50 { background-color: #fef2f2; } /* Rosso Chiaro per Non Trovato */
        .bg-purple-50 { background-color: #f3e8ff; } /* Viola Chiaro per Modifica Manuale (Tailwind purple-50) */

        /* Stile per gli input nelle tabelle */
        .sub-input {
            width: 100%;
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            border-width: 0;
            border-radius: 0.375rem; /* rounded-md */
            background-color: transparent;
            font-size: 0.875rem; /* text-sm */
        }
        .sub-input:focus {
            outline: 2px solid #3b82f6; /* focus:outline-blue-500 */
            background-color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div id="app-container" class="max-w-7xl mx-auto">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestionale Assenze Docenti</h1>

        <!-- Sezione di Stato e Caricamento (Modificata) -->
        <div id="status-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div id="status-header" class="flex justify-between items-center">
                 <h2 id="status-title" class="text-lg font-semibold text-gray-700">
                    Stato Applicazione
                 </h2>
                 <!-- Pulsante per resettare gli orari, inizialmente nascosto -->
                 <button id="clear-schedules-btn" class="hidden bg-red-50 text-red-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-100 transition-colors">
                    Resetta e Ricarica Orari...
                 </button>
            </div>
            
            <!-- Messaggio di stato che guida l'utente -->
            <p id="status-message" class="text-sm text-gray-500 mt-3">Inizializzazione e connessione al database...</p>
            
            <!-- Uploader (ora nascosto di default) -->
            <div id="uploader-container" class="hidden mt-4">
                <p class="text-sm text-gray-500 mb-4">Seleziona tutti i file <code>.csv</code> degli orari. Verranno salvati nel database per i prossimi accessi.</p>
                <input type="file" id="csv-uploader" multiple accept=".csv" 
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-lg file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100 cursor-pointer">
                <div id="loading-spinner" class="hidden mt-4">
                    <p class="text-blue-600 animate-pulse">Caricamento e elaborazione orari... (Potrebbe richiedere un momento)</p>
                </div>
            </div>
            
            <!-- Mostra l'ID utente per trasparenza (nascosto) -->
            <p id="user-id-display" class="hidden mt-4 text-xs text-gray-400"></p>
        </div>


        <!-- Vista Settimanale ("Foglio Settimana") -->
        <div id="weekly-view" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800">Pianificazione Settimanale Assenze</h2>
                <p class="text-sm text-gray-500 mt-2">
                    Inserisci **"A"** per assenza totale o le ore di permesso (es: **"3,4,5"**).
                    <br>
                    Clicca sull'intestazione del giorno (es. "Lunedì") per generare il foglio sostituzioni.
                </p>
            </div>
            <div class="table-container">
                <table id="weekly-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Docente</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Lun">Lunedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Mar">Martedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Mer">Mercoledì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Gio">Giovedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Ven">Venerdì</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Righe generate da JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vista Giornaliera ("Foglio Giorno") -->
        <div id="daily-view" class="hidden mt-12 bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="daily-view-title" class="text-2xl font-semibold text-gray-800">Gestione Sostituzioni</h2>
                <button id="back-to-week" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                    &larr; Torna alla Settimana
                </button>
            </div>
            <div class="daily-table-container">
                <table id="daily-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Ora</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Docente Assente</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Classe / Materia</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Sostituto Assegnato</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Motivazione</th>
                        </tr>
                    </thead>
                    <tbody id="daily-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Righe generate da JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Store globali per gli orari
        let teacherSchedules = {}; // Orari per docente (da orario_doc)
        let classSchedules = {};   // Orari per classe (da orario_cla)
        let classCouncils = {};     // Elenco docenti per classe (da orario_cla)
        let teacherSubjects = {};    // Elenco materie per docente (da orario_doc)

        // Mappa delle colonne dei giorni
        const dayColumnMap = { 'Lun': 1, 'Mar': 2, 'Mer': 3, 'Gio': 4, 'Ven': 5 };
        // Timeslot come da file (10 ore)
        const timeSlots = ["8.00", "8.50", "9.40", "10.30", "11.20", "12.10", "13.00", "13.50", "14.40", "15.30"];

        // --- INIZIO SEZIONE FIREBASE ---
        let app, auth, db, userId;
        let schedulesDocRef; // Riferimento al documento Firestore

        // Elementi DOM (principali)
        const weeklyView = document.getElementById('weekly-view');
        const dailyView = document.getElementById('daily-view');
        const weeklyTbody = document.getElementById('weekly-tbody');
        const dailyTbody = document.getElementById('daily-tbody');
        const dailyViewTitle = document.getElementById('daily-view-title');
        const backToWeekBtn = document.getElementById('back-to-week');
        
        // Elementi DOM per Uploader e Stato
        const csvUploader = document.getElementById('csv-uploader');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusSection = document.getElementById('status-section');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const uploaderContainer = document.getElementById('uploader-container');
        const clearSchedulesBtn = document.getElementById('clear-schedules-btn');
        const userIdDisplay = document.getElementById('user-id-display');


        // Avvio dell'applicazione
        window.onload = async () => {
            // 1. Controlla se le SDK Firebase sono state caricate (dal <script type="module">)
            if (!window.firebase) {
                statusMessage.textContent = "Errore critico: Impossibile caricare le librerie del database. Ricarica la pagina.";
                statusMessage.classList.add("text-red-600", "font-semibold");
                return;
            }
            
            // Estrai le funzioni da window.firebase
            const {
                initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged,
                getFirestore, doc, getDoc, setDoc, deleteDoc, setLogLevel
            } = window.firebase;

            try {
                // 2. Inizializza Firebase
                // Queste variabili globali (__app_id, ecc.) sono fornite dall'ambiente
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(firebaseConfigStr);

                if (!firebaseConfig.apiKey) {
                    statusMessage.textContent = "Errore: Configurazione database non trovata. Impossibile connettersi.";
                    statusMessage.classList.add("text-red-600", "font-semibold");
                    return;
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Utile per il debug in console

                // Definisci il percorso del documento: un singolo documento per tutti gli orari
                const schedulesDocPath = `/artifacts/${appId}/public/data/schedules/main`;
                schedulesDocRef = doc(db, schedulesDocPath);

                // 3. Autenticazione (necessaria per Firestore)
                statusMessage.textContent = "Autenticazione in corso...";
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    console.warn("Token non trovato, avvio come anonimo.");
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                userIdDisplay.textContent = `ID Sessione: ${userId}`; // Mostra l'ID
                userIdDisplay.classList.remove('hidden');

                // 4. Carica i dati da Firestore
                // Questo è il "Passo 1" per l'utente
                statusMessage.textContent = "Ricerca orari salvati nel database...";
                await loadSchedulesFromFirestore();

            } catch (error) {
                console.error("Errore di inizializzazione Firebase:", error);
                statusMessage.textContent = `Errore di connessione al database: ${error.message}`;
                statusMessage.classList.add("text-red-600", "font-semibold");
            }
        };

        /**
         * Carica gli orari da Firestore
         */
        async function loadSchedulesFromFirestore() {
            const { getDoc } = window.firebase;
            try {
                const docSnap = await getDoc(schedulesDocRef);

                if (docSnap.exists()) {
                    // "Passo 3" (Uso normale) - Dati trovati!
                    console.log("Dati caricati da Firestore");
                    const data = docSnap.data();
                    
                    // Popola le variabili globali
                    teacherSchedules = data.teacherSchedules || {};
                    classSchedules = data.classSchedules || {};
                    classCouncils = data.classCouncils || {};
                    teacherSubjects = data.teacherSubjects || {};
                    
                    // Aggiorna l'UI
                    statusTitle.textContent = "Orari Caricati";
                    statusMessage.textContent = "Orari caricati con successo dal database. Puoi iniziare a pianificare le assenze.";
                    uploaderContainer.classList.add('hidden');
                    clearSchedulesBtn.classList.remove('hidden'); // Mostra il pulsante "Resetta"
                    
                    // Renderizza la tabella
                    renderWeeklyTable();
                    weeklyView.classList.remove('hidden');

                } else {
                    // "Passo 2" (Prima volta) - Nessun dato trovato
                    console.log("Nessun orario trovato nel database. Mostro l'uploader.");
                    statusTitle.textContent = "Benvenuto!";
                    statusMessage.textContent = "Nessun orario trovato. Per iniziare, carica i file CSV (docenti e classi) qui sotto. Verranno salvati automaticamente per i futuri accessi.";
                    uploaderContainer.classList.remove('hidden'); // Mostra l'uploader
                    clearSchedulesBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error("Errore nel caricare i dati da Firestore:", error);
                statusMessage.textContent = `Errore di lettura dal database: ${error.message}`;
                statusMessage.classList.add("text-red-600", "font-semibold");
                uploaderContainer.classList.remove('hidden'); // Mostra uploader come fallback
            }
        }

        /**
         * Salva gli orari processati su Firestore
         */
        async function saveSchedulesToFirestore() {
            if (!schedulesDocRef) {
                 console.error("Salvataggio fallito: riferimento al database non inizializzato.");
                 return;
            }
            
            const { setDoc } = window.firebase;
            
            // Crea un unico oggetto da salvare
            const dataToSave = {
                teacherSchedules,
                classSchedules,
                classCouncils,
                teacherSubjects,
                savedAt: new Date().toISOString() // Data salvataggio
            };
            
            try {
                statusMessage.textContent = "Salvataggio orari nel database...";
                await setDoc(schedulesDocRef, dataToSave);
                console.log("Orari salvati con successo in Firestore!");
                statusMessage.textContent = "Orari salvati nel database per i futuri accessi.";
                statusTitle.textContent = "Orari Caricati e Salvati";
                uploaderContainer.classList.add('hidden');
                clearSchedulesBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Errore nel salvataggio in Firestore:", error);
                statusMessage.textContent = `Errore nel salvataggio nel database: ${error.message}`;
                statusMessage.classList.add("text-red-600", "font-semibold");
            }
        }

        /**
         * Resetta gli orari (elimina da Firestore e ricarica la pagina)
         */
        clearSchedulesBtn.addEventListener('click', async () => {
            // Non uso confirm() perché bloccante, gestisco direttamente
            statusMessage.textContent = "Eliminazione orari dal database in corso...";
            statusMessage.classList.remove("text-red-600", "font-semibold");
            
            const { deleteDoc } = window.firebase;
            
            try {
                await deleteDoc(schedulesDocRef);
                console.log("Documento eliminato. Ricaricamento pagina.");
                statusMessage.textContent = "Orari resettati. Ricaricamento in corso...";
                // Ricarica la pagina per ricominciare il processo (mostrerà l'uploader)
                location.reload(); 
            } catch (error) {
                console.error("Errore nell'eliminazione del documento:", error);
                statusMessage.textContent = `Errore durante il reset: ${error.message}`;
                statusMessage.classList.add("text-red-600", "font-semibold");
            }
        });
        // --- FINE SEZIONE FIREBASE ---


        // Event listener per il caricamento file
        csvUploader.addEventListener('change', handleFiles);

        // Event listener per il pulsante "Indietro"
        backToWeekBtn.addEventListener('click', () => {
            dailyView.classList.add('hidden');
            weeklyView.classList.remove('hidden');
            window.scrollTo(0, weeklyView.offsetTop);
        });

        /**
         * Gestisce i file CSV caricati dall'utente (MODIFICATA)
         */
        function handleFiles(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            // Resetta gli store
            teacherSchedules = {};
            classSchedules = {};
            classCouncils = {};
            teacherSubjects = {};
            loadingSpinner.classList.remove('hidden');
            weeklyTbody.innerHTML = '';
            weeklyView.classList.add('hidden');
            dailyView.classList.add('hidden');
            statusMessage.textContent = "Elaborazione file CSV..."; // Messaggio di caricamento

            const promises = [];
            let docFilesCount = 0; // Contatore per file docenti
            let claFilesCount = 0; // Contatore per file classi

            for (const file of files) {
                const promise = new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const text = e.target.result;
                            
                            // *** INIZIO LOGICA DI RICONOSCIMENTO FILE ***
                            const lines = text.split(/\r?\n/);
                            if (lines.length < 2) { 
                                console.warn(`File saltato: ${file.name} è troppo corto o vuoto.`);
                                resolve();
                                return;
                            }

                            const firstLine = lines[0];
                            const namePart = firstLine.split(',')[0].trim();

                            if (!namePart) {
                                console.warn(`File saltato: ${file.name} non ha un nome nella prima riga.`);
                                resolve();
                                return;
                            }

                            // Heuristic: Nomi docenti hanno spazio (es. "ROSSI M."), classi no (es. "1A").
                            if (namePart.includes(' ')) {
                                // È un file DOCENTE
                                if (parseTeacherSchedule(text, file.name)) {
                                    docFilesCount++;
                                }
                            } else {
                                // È un file CLASSE
                                if (parseClassSchedule(text, file.name)) {
                                    claFilesCount++;
                                }
                            }
                            // *** FINE LOGICA DI RICONOSCIMENTO FILE ***
                            
                            resolve();
                        } catch (error) {
                            console.error(`Errore nel processare il file ${file.name}:`, error);
                            reject(error);
                        }
                    };
                    reader.onerror = (e) => {
                        console.error(`Errore nel leggere il file ${file.name}:`, e);
                        reject(e);
                    }
                    reader.readAsText(file); // Usa encoding default (UTF-8)
                });
                promises.push(promise);
            }

            // Aspetta che tutti i file siano stati processati
            Promise.all(promises)
                .then(async () => { // Aggiunto async
                    console.log(`Processamento completato. File docenti validi: ${docFilesCount}, File classi validi: ${claFilesCount}`);
                    console.log('Orari docenti processati:', teacherSchedules);
                    console.log('Orari classi processati:', classSchedules);
                    console.log('Consigli di classe processati:', classCouncils);
                    console.log('Materie docenti processate:', teacherSubjects);
                    
                    loadingSpinner.classList.add('hidden');
                    
                    if (docFilesCount === 0 || claFilesCount === 0) {
                         const errorMsg = `Errore: File docenti trovati: ${docFilesCount}, File classi trovati: ${claFilesCount}. Entrambi sono necessari.`;
                         console.error(errorMsg);
                         statusMessage.textContent = errorMsg + " Riprova a caricare tutti i file.";
                         statusMessage.classList.add("text-red-600", "font-semibold");
                         weeklyView.classList.add('hidden'); 
                    } else {
                         // Dati validi, SALVA in Firestore
                         await saveSchedulesToFirestore(); // <-- NUOVA CHIAMATA
                         
                         // Renderizza la tabella e mostra la vista
                         renderWeeklyTable();
                         weeklyView.classList.remove('hidden');
                    }
                })
                .catch((error) => {
                    console.error("Errore durante il processamento dei file:", error);
                    loadingSpinner.classList.add('hidden');
                    statusMessage.textContent = `Si è verificato un errore: ${error.message}`;
                    statusMessage.classList.add("text-red-600", "font-semibold");
                });
        }
        
        /**
         * Popola la tabella settimanale con i docenti
         */
        function renderWeeklyTable() {
            weeklyTbody.innerHTML = ''; // Pulisce la tabella
            
            // Ordina i nomi dei docenti
            const sortedTeachers = Object.keys(teacherSchedules).sort();
            
            if (sortedTeachers.length === 0) {
                 weeklyTbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Nessun docente trovato negli orari.</td></tr>';
                 return;
            }

            // Aggiunge listener per i click sugli header dei giorni
            document.querySelectorAll('#weekly-table th[data-day]').forEach(th => {
                th.addEventListener('click', () => showDailyView(th.dataset.day));
            });

            // Crea una riga per ogni docente
            for (const teacherName of sortedTeachers) {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-50');
                tr.innerHTML = `<td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${teacherName}</td>`;
                for (const day of Object.keys(dayColumnMap)) {
                    const td = document.createElement('td');
                    td.classList.add('p-3', 'text-center');
                    // Sostituisci checkbox con input di testo
                    td.innerHTML = `<input type="text" 
                                           class="absence-input w-20 text-center border border-gray-300 rounded-md p-1 text-sm uppercase" 
                                           data-teacher="${teacherName}" 
                                           data-day="${day}"
                                           placeholder="A / 3,4">`;
                    tr.appendChild(td);
                }
                weeklyTbody.appendChild(tr);
            }
        }

        /**
         * Esegue il parsing del CSV di un docente
         */
        function parseTeacherSchedule(csvText, fileName) {
            const lines = csvText.split(/\r?\n/);
            // La prima riga, colonna 0, è il nome
            const teacherName = lines[0].split(',')[0].trim();
            if (!teacherName || teacherName.length < 3) {
                 console.warn(`Nome docente non valido nel file ${fileName}: ${teacherName}`);
                 return false;
            }

            teacherSchedules[teacherName] = {};
            if (!teacherSubjects[teacherName]) {
                 teacherSubjects[teacherName] = new Set();
            }

            const days = Object.keys(dayColumnMap); // ['Lun', 'Mar', ...]
            
            // Itera le righe dell'orario (dalla 1 alla 10)
            for (let i = 0; i < timeSlots.length; i++) {
                const lineIndex = i + 1; // Le righe CSV partono da 1 (dopo l'intestazione)
                if (lineIndex >= lines.length) break;

                const cols = lines[lineIndex].split(',');
                
                for (const day of days) {
                    const colIndex = dayColumnMap[day];
                    if (colIndex >= cols.length) continue;

                    const entry = cols[colIndex].trim();
                    if (!teacherSchedules[teacherName][day]) {
                        teacherSchedules[teacherName][day] = [];
                    }
                    teacherSchedules[teacherName][day][i] = entry; // Salva l'impegno per quell'ora

                    // Popola l'elenco delle materie
                    if (entry && !entry.toLowerCase().includes('ora disposizione')) {
                        const subject = entry.split(' - ')[1]?.trim().replace('.', '');
                        if (subject) {
                            teacherSubjects[teacherName].add(subject);
                        }
                    }
                }
            }
            // Converte il Set in Array per salvarlo (JSON non supporta Set)
            teacherSubjects[teacherName] = Array.from(teacherSubjects[teacherName]);
            return true;
        }

        /**
         * Esegue il parsing del CSV di una classe
         */
        function parseClassSchedule(csvText, fileName) {
            const lines = csvText.split(/\r?\n/);
            // La prima riga, colonna 0, è il nome della classe
            const className = lines[0].split(',')[0].trim();
            if (!className || className.length > 5) {
                console.warn(`Nome classe non valido nel file ${fileName}: ${className}`);
                return false;
            }

            classSchedules[className] = {};
            classCouncils[className] = new Set(); // Usiamo un Set per evitare duplicati

            const days = Object.keys(dayColumnMap); // ['Lun', 'Mar', ...]

            // Itera le righe dell'orario (dalla 1 alla 10)
            for (let i = 0; i < timeSlots.length; i++) {
                const lineIndex = i + 1;
                if (lineIndex >= lines.length) break;
                
                const cols = lines[lineIndex].split(',');

                for (const day of days) {
                    const colIndex = dayColumnMap[day];
                    if (colIndex >= cols.length) continue;

                    const entry = cols[colIndex].trim();
                    if (!classSchedules[className][day]) {
                        classSchedules[className][day] = [];
                    }
                    classSchedules[className][day][i] = entry; // Salva l'impegno

                    // Popola il consiglio di classe
                    if (entry) {
                        // Gestisce compresenze (es. "MAT - ROSSI / FIS - BIANCHI")
                        const teachers = entry.split(' / ').map(e => e.split(' - ')[1]?.trim()).filter(Boolean);
                        teachers.forEach(t => classCouncils[className].add(t));
                    }
                }
            }
            // Converte il Set in Array per salvarlo
            classCouncils[className] = Array.from(classCouncils[className]);
            return true;
        }

        /**
         * Filtra i docenti presenti e trova quelli a disposizione in una data ora
         */
        function getAvailableTeachers(hourIndex, dayName, allPresentTeachers) {
            const currentHour = hourIndex + 1; // Ora 1-based

            return allPresentTeachers.filter(teacherName => {
                // 1. Controlla se è a disposizione
                const scheduleEntry = teacherSchedules[teacherName]?.[dayName]?.[hourIndex];
                if (!scheduleEntry || !scheduleEntry.toLowerCase().includes('ora disposizione')) {
                    return false; // Non è a disposizione
                }

                // 2. Controlla se è in permesso breve in quest'ora specifica
                const input = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                // Usiamo toUpperCase() per coerenza, anche se 'A' è già filtrato
                const absenceValue = input?.value.trim().toUpperCase() || ''; 
                
                if (absenceValue === '') {
                     // Non è in permesso breve, è presente
                     return true; 
                }

                // È in permesso parziale (es. "3,4,5")
                // Filtriamo anche per NaN se l'utente scrive "3,"
                const absentHours = absenceValue.split(',')
                                          .map(h => parseInt(h.trim(), 10))
                                          .filter(h => !isNaN(h));
                
                if (absentHours.includes(currentHour)) {
                    return false; // È a disposizione, ma in permesso in quest'ora
                }

                return true; // È a disposizione e non in permesso in quest'ora
            });
        }

        /**
         * Trova un sostituto seguendo la logica delle priorità
         */
        function findSubstitute(absentee, absentClass, absentSubject, availableTeachers) {
            const { name: absentTeacherName } = absentee;
            
            // Priorità 1: Docente della Classe (colore Azzurro)
            const classCouncil = classCouncils[absentClass] || [];
            const p1_substitute = availableTeachers.find(t => classCouncil.includes(t));
            if (p1_substitute) {
                return { substitute: p1_substitute, reason: "Docente della Classe", color: "bg-blue-50", textColor: "text-gray-900" };
            }

            // Priorità 2: Stessa Materia (colore Arancione)
            const absentTeacherSubjects = teacherSubjects[absentTeacherName] || [];
            const p2_substitute = availableTeachers.find(t => {
                const subSubjects = teacherSubjects[t] || [];
                // Controlla se c'è almeno una materia in comune
                return subSubjects.some(subSubject => absentTeacherSubjects.includes(subSubject));
            });
            if (p2_substitute) {
                return { substitute: p2_substitute, reason: "Stessa Materia", color: "bg-orange-50", textColor: "text-gray-900" };
            }

            // Priorità 3: Disponibilità Generica (colore Verde)
            if (availableTeachers.length > 0) {
                const p3_substitute = availableTeachers[0]; // Prende il primo disponibile
                return { substitute: p3_substitute, reason: "Disponibilità Generica", color: "bg-green-50", textColor: "text-gray-900" };
            }

            // Caso 4: Sostituto NON Trovato (colore Rosso)
            return { substitute: "NON TROVATO", reason: "Nessun docente disponibile", color: "bg-red-50", textColor: "text-red-700" };
        }
        
        /**
         * Trova docenti in compresenza che possono essere "spezzati"
         */
        function findBreakableCoTeachers(hourIndex, dayName, allPresentTeachers) {
            let options = [];
            // Itera su tutti gli orari delle classi
            for (const className in classSchedules) {
                const entry = classSchedules[className]?.[dayName]?.[hourIndex];
                
                // Cerca una compresenza (es. "MAT - ROSSI / FIS - BIANCHI")
                if (entry && entry.includes(' / ')) {
                    const teachers = entry.split(' / ').map(e => e.split(' - ')[1]?.trim()).filter(Boolean);
                    
                    // Se ci sono due docenti E entrambi sono nell'elenco dei "presenti"
                    if (teachers.length === 2 && allPresentTeachers.includes(teachers[0]) && allPresentTeachers.includes(teachers[1])) {
                        // Aggiungi entrambi i docenti come opzioni "spezzabili"
                        options.push({ name: teachers[0], fromClass: className, with: teachers[1] });
                        options.push({ name: teachers[1], fromClass: className, with: teachers[0] });
                    }
                }
            }
            return options;
        }


        /**
         * Mostra la vista giornaliera ("Foglio Giorno") per il giorno selezionato
         */
        function showDailyView(dayName) {
            const dayTitles = { Lun: "Lunedì", Mar: "Martedì", Mer: "Mercoledì", Gio: "Giovedì", Ven: "Venerdì" };
            
            dailyViewTitle.textContent = `Gestione Sostituzioni per ${dayTitles[dayName]}`;
            weeklyView.classList.add('hidden');
            dailyView.classList.remove('hidden');
            dailyTbody.innerHTML = ''; 
            window.scrollTo(0, 0); 

            // Trova tutti i docenti *presenti* oggi (non assenti "A" tutto il giorno)
            const allPresentTeachers = Object.keys(teacherSchedules).filter(teacherName => {
                const input = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                const absenceValue = input?.value.trim().toUpperCase() || '';
                return absenceValue !== 'A'; // Include presenti e assenti parziali
            });

            // Itera attraverso le 10 ore
            for (let hourIndex = 0; hourIndex < timeSlots.length; hourIndex++) {
                const hourSlot = timeSlots[hourIndex];
                const hourLabel = `${hourIndex + 1}a Ora <span class="text-xs text-gray-400">(${hourSlot})</span>`;
                const currentHour = hourIndex + 1; // Ora 1-based per controllo permessi

                // 1. Trova docenti assenti CHE HANNO LEZIONE in quest'ora
                const absentTeachersThisHour = [];
                for (const teacherName in teacherSchedules) {
                    const input = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                    const absenceValue = input?.value.trim().toUpperCase() || '';

                    if (absenceValue === '') {
                        continue; // Presente
                    }

                    let isAbsentThisHour = false;
                    if (absenceValue === 'A') {
                        isAbsentThisHour = true; // Assente tutto il giorno
                    } else {
                        // Controlla permesso breve, es. "3,4,5"
                        // Aggiungiamo un filtro per NaN (es. se scrive "3,")
                        const absentHours = absenceValue.split(',')
                                                      .map(h => parseInt(h.trim(), 10))
                                                      .filter(h => !isNaN(h));
                        if (absentHours.includes(currentHour)) {
                            isAbsentThisHour = true;
                        }
                    }

                    if (isAbsentThisHour) {
                        const scheduleEntry = teacherSchedules[teacherName]?.[dayName]?.[hourIndex];
                        // Considera assente solo se ha una lezione (non "ora disposizione")
                        if (scheduleEntry && !scheduleEntry.toLowerCase().includes('ora disposizione')) {
                            const parts = scheduleEntry.split(' - ');
                            const absentClass = parts[0]?.trim();
                            const absentSubject = parts[1]?.trim().replace('.', '');
                            absentTeachersThisHour.push({ name: teacherName, class: absentClass, subject: absentSubject, fullEntry: scheduleEntry });
                        }
                    }
                }

                // 2. Trova docenti a disposizione in quest'ora
                const availableNow = getAvailableTeachers(hourIndex, dayName, allPresentTeachers);
                
                // 2.5 Trova docenti "spezzabili" da compresenze
                const breakableCoTeachers = findBreakableCoTeachers(hourIndex, dayName, allPresentTeachers);
                
                // Crea il datalist per i suggerimenti
                const dataListId = `dl-${dayName}-${hourIndex}`;
                let dataListHtml = `<datalist id="${dataListId}">`;
                if (breakableCoTeachers.length > 0) {
                    dataListHtml += `<optgroup label="Spezzando Compresenza">`;
                    // Usiamo un Set per evitare doppioni se un docente è in compresenza e a disp.
                    const breakableNames = new Set();
                    for (const coTeacher of breakableCoTeachers) {
                        if (!availableNow.includes(coTeacher.name)) { // Mostra solo se non è GIA' a disposizione
                           dataListHtml += `<option value="${coTeacher.name} (da ${coTeacher.fromClass} con ${coTeacher.with})"></option>`;
                           breakableNames.add(coTeacher.name);
                        }
                    }
                    dataListHtml += `</optgroup>`;
                }
                // Aggiungiamo anche i docenti a disposizione "normali" ai suggerimenti
                if (availableNow.length > 0) {
                     dataListHtml += `<optgroup label="A Disposizione">`;
                    for (const available of availableNow) {
                         dataListHtml += `<option value="${available}"></option>`;
                    }
                     dataListHtml += `</optgroup>`;
                }
                dataListHtml += "</datalist>";


                // 3. Costruisci le righe della tabella
                if (absentTeachersThisHour.length === 0) {
                    // Nessun assente, mostra solo l'ora e chi è a disposizione
                    const availableStr = availableNow.length > 0 ? availableNow.join(', ') : '<em class="text-gray-400">Nessuno</em>';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3 text-sm font-medium text-gray-900">${hourLabel}</td>
                        <td class="p-3 text-sm text-gray-500 italic">/</td>
                        <td class="p-3 text-sm text-gray-500 italic">/</td>
                        <td class="p-3 text-sm text-gray-700">${availableStr} ${dataListHtml}</td> <!-- Aggiunto datalist anche qui -->
                        <td class="p-3 text-sm text-gray-500 italic">Docenti a Disp.</td>
                    `;
                    dailyTbody.appendChild(tr);
                } else {
                    // Ci sono uno o più assenti
                    for (let i = 0; i < absentTeachersThisHour.length; i++) {
                        const absentee = absentTeachersThisHour[i];
                        const { name, class: absentClass, subject: absentSubject, fullEntry } = absentee;
                        
                        let substituteResult = null;

                        // Priorità 0: Controllo Compresenza (colore Giallo)
                        let isCoPresence = false;
                        const classScheduleEntry = classSchedules[absentClass]?.[dayName]?.[hourIndex];
                        
                        if (classScheduleEntry && classScheduleEntry.includes(' / ')) {
                            const teachersInClass = classScheduleEntry.split(' / ').map(entry => entry.split(' - ')[1]?.trim());
                            const otherTeacherPresent = teachersInClass.find(tName => {
                                if (!tName || tName === name) return false; // Non controllare se stesso
                                return allPresentTeachers.includes(tName); // Controlla se l'altro docente è nell'elenco dei presenti
                            });

                            if (otherTeacherPresent) {
                                isCoPresence = true;
                                substituteResult = { substitute: `(${otherTeacherPresent})`, reason: "Copertura in Compresenza", color: "bg-yellow-50", textColor: "text-gray-900" };
                            }
                        }
                        
                        // Priorità 1-3: Ricerca Sostituto
                        if (!isCoPresence) {
                            substituteResult = findSubstitute(absentee, absentClass, absentSubject, availableNow);
                        }
                        
                        // Renderizza la riga
                        const tr = document.createElement('tr');
                        tr.className = substituteResult.color;
                        
                        const tdHour = document.createElement('td');
                        tdHour.className = `p-3 text-sm font-medium ${substituteResult.textColor}`;
                        tdHour.innerHTML = i === 0 ? hourLabel : '';
                        
                        const tdAbsent = document.createElement('td');
                        tdAbsent.className = `p-3 text-sm font-semibold text-red-700`;
                        tdAbsent.textContent = name;
                        
                        const tdClass = document.createElement('td');
                        tdClass.className = `p-3 text-sm text-red-700`;
                        tdClass.textContent = fullEntry;

                        // --- Cella Sostituto (Modificabile) ---
                        const tdSub = document.createElement('td');
                        tdSub.className = `p-0`; // Padding zero per far riempire l'input
                        const subInput = document.createElement('input');
                        subInput.type = 'text';
                        subInput.className = `sub-input ${substituteResult.color}`;
                        subInput.value = substituteResult.substitute;
                        subInput.setAttribute('list', dataListId); // Collega al datalist
                        // Aggiunge il datalist (nascosto) a questa cella
                        subInput.insertAdjacentHTML('afterend', dataListHtml); 
                        tdSub.appendChild(subInput);

                        // --- Cella Motivazione (Modificabile) ---
                        const tdReason = document.createElement('td');
                        tdReason.className = `p-0`;
                        const reasonInput = document.createElement('input');
                        reasonInput.type = 'text';
                        reasonInput.className = `sub-input ${substituteResult.color}`;
                        reasonInput.value = substituteResult.reason;
                        tdReason.appendChild(reasonInput);

                        // Funzione per cambiare colore in "Manuale" (Viola)
                        const setManualOverride = () => {
                            subInput.className = `sub-input bg-purple-50`;
                            reasonInput.className = `sub-input bg-purple-50`;
                            tr.className = `bg-purple-50`; // Cambia colore anche alla riga
                            if (reasonInput.value === substituteResult.reason) {
                                reasonInput.value = "Modifica Manuale";
                            }
                        };
                        
                        subInput.addEventListener('input', setManualOverride);
                        reasonInput.addEventListener('input', setManualOverride);

                        tr.appendChild(tdHour);
                        tr.appendChild(tdAbsent);
                        tr.appendChild(tdClass);
                        tr.appendChild(tdSub);
                        tr.appendChild(tdReason);
                        
                        dailyTbody.appendChild(tr);
                    }
                }
            }
        }

    </script>
</body>
</html>

