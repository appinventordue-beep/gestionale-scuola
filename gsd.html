<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Assenze Docenti</title>
    <!-- Importa Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importa la font Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        /* Stile base con la font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Stili per la tabella "sticky header" */
        .table-container {
            max-height: 60vh; /* Altezza massima per la tabella settimanale */
            overflow-y: auto;
        }
        .daily-table-container {
            max-height: 70vh; /* Altezza massima per la tabella giornaliera */
            overflow-y: auto;
        }
        th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Nasconde la freccia standard dei checkbox */
        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0.25rem; /* rounded */
            border-width: 1px;
            border-color: #cbd5e0; /* gray-400 */
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            cursor: pointer;
            vertical-align: middle;
            position: relative;
        }
        /* Stile personalizzato per il checkbox "checked" */
        input[type="checkbox"]:checked {
            background-color: #dc2626; /* red-600 */
            border-color: #dc2626; /* red-600 */
        }
        /* Aggiunge la "A" di Assente al checkbox */
        input[type="checkbox"]:checked::after {
            content: 'A';
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* Colori di sfondo per la motivazione */
        .bg-yellow-50 { background-color: #fffbeb; } /* Giallo Chiaro per Compresenza */
        .bg-blue-50 { background-color: #eff6ff; } /* Azzurro Chiaro per Docente Classe */
        .bg-orange-50 { background-color: #fff7ed; } /* Arancione Chiaro per Stessa Materia */
        .bg-green-50 { background-color: #f0fdf4; } /* Verde Chiaro per Disponibilità */
        .bg-red-50 { background-color: #fef2f2; } /* Rosso Chiaro per Non Trovato */
        .bg-purple-50 { background-color: #f3e8ff; } /* Viola Chiaro per Modifica Manuale (Tailwind purple-50) */

        /* Stile per gli input nelle tabelle */
        .sub-input {
            width: 100%;
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            border-width: 0;
            border-radius: 0.375rem; /* rounded-md */
            background-color: transparent;
            font-size: 0.875rem; /* text-sm */
        }
        .sub-input:focus {
            outline: 2px solid #3b82f6; /* focus:outline-blue-500 */
            background-color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div id="app-container" class="max-w-7xl mx-auto">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestionale Assenze Docenti</h1>

        <!-- Sezione di Caricamento File -->
        <div id="uploader-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <label for="csv-uploader" class="block text-lg font-semibold text-gray-700 mb-3">
                1. Carica i file CSV (Docenti e Classi)
            </label>
            <p class="text-sm text-gray-500 mb-4">Seleziona tutti i file <code>.csv</code> degli orari. Lo script riconoscerà automaticamente i file docenti e classi.</p>
            <input type="file" id="csv-uploader" multiple accept=".csv" 
                   class="block w-full text-sm text-gray-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-lg file:border-0
                          file:text-sm file:font-semibold
                          file:bg-blue-50 file:text-blue-700
                          hover:file:bg-blue-100 cursor-pointer">
            <div id="loading-spinner" class="hidden mt-4">
                <p class="text-blue-600 animate-pulse">Caricamento e elaborazione orari...</p>
            </div>
        </div>

        <!-- Vista Settimanale ("Foglio Settimana") -->
        <div id="weekly-view" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800">2. Pianificazione Settimanale Assenze</h2>
                <p class="text-sm text-gray-500 mt-2">
                    Seleziona le caselle per segnare un docente come "Assente" in un dato giorno. 
                    <br>
                    Clicca sull'intestazione del giorno (es. "Lun") per generare il foglio sostituzioni per quel giorno.
                </p>
            </div>
            <div class="table-container">
                <table id="weekly-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Docente</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Lun">Lunedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Mar">Martedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Mer">Mercoledì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Gio">Giovedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Ven">Venerdì</th>
                            <!-- Sabato è escluso come da richiesta implicita (Lun-Ven) -->
                        </tr>
                    </thead>
                    <tbody id="weekly-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Righe generate da JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vista Giornaliera ("Foglio Giorno") -->
        <div id="daily-view" class="hidden mt-12 bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="daily-view-title" class="text-2xl font-semibold text-gray-800">Gestione Sostituzioni</h2>
                <button id="back-to-week" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                    &larr; Torna alla Settimana
                </button>
            </div>
            <div class="daily-table-container">
                <table id="daily-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Ora</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Docente Assente</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Classe / Materia</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Sostituto Assegnato</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Motivazione</th>
                        </tr>
                    </thead>
                    <tbody id="daily-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Righe generate da JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Store globali per gli orari
        let teacherSchedules = {}; // Orari per docente (da orario_doc)
        let classSchedules = {};   // Orari per classe (da orario_cla)
        let classCouncils = {};     // Elenco docenti per classe (da orario_cla)
        let teacherSubjects = {};    // Elenco materie per docente (da orario_doc)

        // Mappa delle colonne dei giorni
        const dayColumnMap = { 'Lun': 1, 'Mar': 2, 'Mer': 3, 'Gio': 4, 'Ven': 5 };
        // Timeslot come da file (10 ore)
        const timeSlots = ["8.00", "8.50", "9.40", "10.30", "11.20", "12.10", "13.00", "13.50", "14.40", "15.30"];

        // Elementi DOM
        const csvUploader = document.getElementById('csv-uploader');
        const loadingSpinner = document.getElementById('loading-spinner');
        const weeklyView = document.getElementById('weekly-view');
        const dailyView = document.getElementById('daily-view');
        const weeklyTbody = document.getElementById('weekly-tbody');
        const dailyTbody = document.getElementById('daily-tbody');
        const dailyViewTitle = document.getElementById('daily-view-title');
        const backToWeekBtn = document.getElementById('back-to-week');

        // Event listener per il caricamento file
        csvUploader.addEventListener('change', handleFiles);

        // Event listener per il pulsante "Indietro"
        backToWeekBtn.addEventListener('click', () => {
            dailyView.classList.add('hidden');
            weeklyView.classList.remove('hidden');
            window.scrollTo(0, weeklyView.offsetTop);
        });

        /**
         * Gestisce i file CSV caricati dall'utente
         */
        function handleFiles(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            // Resetta gli store
            teacherSchedules = {};
            classSchedules = {};
            classCouncils = {};
            teacherSubjects = {};
            loadingSpinner.classList.remove('hidden');
            weeklyTbody.innerHTML = '';
            weeklyView.classList.add('hidden');
            dailyView.classList.add('hidden');

            const promises = [];
            let docFilesCount = 0; // Contatore per file docenti
            let claFilesCount = 0; // Contatore per file classi

            for (const file of files) {
                const promise = new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const text = e.target.result;
                            
                            // *** INIZIO LOGICA DI RICONOSCIMENTO FILE ***
                            const lines = text.split(/\r?\n/);
                            if (lines.length < 2) { // Serve almeno l'intestazione e una riga
                                console.warn(`File saltato: ${file.name} è troppo corto o vuoto.`);
                                resolve();
                                return;
                            }

                            const firstLine = lines[0];
                            const namePart = firstLine.split(',')[0].trim();

                            if (!namePart) {
                                console.warn(`File saltato: ${file.name} non ha un nome nella prima riga.`);
                                resolve();
                                return;
                            }

                            // Heuristic: I nomi dei docenti contengono uno spazio (es. "ROSSI M."),
                            // i nomi delle classi no (es. "1A", "1QA").
                            if (namePart.includes(' ')) {
                                // È un file DOCENTE
                                if (parseTeacherSchedule(text, file.name)) {
                                    docFilesCount++;
                                }
                            } else {
                                // È un file CLASSE
                                if (parseClassSchedule(text, file.name)) {
                                    claFilesCount++;
                                }
                            }
                            // *** FINE LOGICA DI RICONOSCIMENTO FILE ***
                            
                            resolve();
                        } catch (error) {
                            console.error(`Errore nel processare il file ${file.name}:`, error);
                            reject(error);
                        }
                    };
                    reader.onerror = (e) => {
                        console.error(`Errore nel leggere il file ${file.name}:`, e);
                        reject(e);
                    }
                    reader.readAsText(file); // Usa encoding default (UTF-8)
                });
                promises.push(promise);
            }

            // Aspetta che tutti i file siano stati processati
            Promise.all(promises)
                .then(() => {
                    console.log(`Processamento completato. File docenti validi: ${docFilesCount}, File classi validi: ${claFilesCount}`);
                    console.log('Orari docenti processati:', teacherSchedules);
                    console.log('Orari classi processati:', classSchedules);
                    console.log('Consigli di classe processati:', classCouncils);
                    console.log('Materie docenti processate:', teacherSubjects);
                    
                    loadingSpinner.classList.add('hidden');
                    
                    if (docFilesCount === 0) {
                         console.error("Nessun file docente valido è stato caricato. Controllo euristica fallito.");
                         // Mostra l'errore anche nell'UI
                         weeklyTbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-600 font-semibold">Errore: Nessun file docente valido è stato riconosciuto. Controlla la console per i dettagli.</td></tr>';
                    } else {
                         renderWeeklyTable();
                    }
                    
                    weeklyView.classList.remove('hidden');
                })
                .catch((error) => {
                    console.error("Errore durante il processamento dei file:", error);
                    loadingSpinner.classList.add('hidden');
                    // Non usare alert()
                    console.error("Si è verificato un errore durante il caricamento di alcuni file.");
                });
        }

        /**
         * Trova docenti in compresenza che possono essere "spezzati"
         */
        function findBreakableCoTeachers(hourIndex, dayName, allPresentTeachers) {
            let options = [];
            // Itera su tutti gli orari delle classi
            for (const className in classSchedules) {
                const entry = classSchedules[className]?.[dayName]?.[hourIndex];
                
                // Cerca una compresenza (es. "MAT - ROSSI / FIS - BIANCHI")
                if (entry && entry.includes(' / ')) {
                    const teachers = entry.split(' / ').map(e => e.split(' - ')[1]?.trim()).filter(Boolean);
                    
                    // Se ci sono due docenti E entrambi sono nell'elenco dei "presenti"
                    if (teachers.length === 2 && allPresentTeachers.includes(teachers[0]) && allPresentTeachers.includes(teachers[1])) {
                        // Aggiungi entrambi i docenti come opzioni "spezzabili"
                        options.push({ name: teachers[0], fromClass: className, with: teachers[1] });
                        options.push({ name: teachers[1], fromClass: className, with: teachers[0] });
                    }
                }
            }
            return options;
        }


        /**
         * Mostra la vista giornaliera ("Foglio Giorno") per il giorno selezionato
         */
        function showDailyView(dayName) {
            const dayTitles = { Lun: "Lunedì", Mar: "Martedì", Mer: "Mercoledì", Gio: "Giovedì", Ven: "Venerdì" };
            
            dailyViewTitle.textContent = `Gestione Sostituzioni per ${dayTitles[dayName]}`;
            weeklyView.classList.add('hidden');
            dailyView.classList.remove('hidden');
            dailyTbody.innerHTML = ''; 
            window.scrollTo(0, 0); 

            // Trova tutti i docenti *presenti* oggi (non assenti "A" tutto il giorno)
            const allPresentTeachers = Object.keys(teacherSchedules).filter(teacherName => {
                const input = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                const absenceValue = input?.value.trim().toUpperCase() || '';
                return absenceValue !== 'A'; // Include presenti e assenti parziali
            });

            // Itera attraverso le 10 ore
            for (let hourIndex = 0; hourIndex < timeSlots.length; hourIndex++) {
                const hourSlot = timeSlots[hourIndex];
                const hourLabel = `${hourIndex + 1}a Ora <span class="text-xs text-gray-400">(${hourSlot})</span>`;
                const currentHour = hourIndex + 1; // Ora 1-based per controllo permessi

                // 1. Trova docenti assenti CHE HANNO LEZIONE in quest'ora
                const absentTeachersThisHour = [];
                for (const teacherName in teacherSchedules) {
                    const input = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                    const absenceValue = input?.value.trim().toUpperCase() || '';

                    if (absenceValue === '') {
                        continue; // Presente
                    }

                    let isAbsentThisHour = false;
                    if (absenceValue === 'A') {
                        isAbsentThisHour = true; // Assente tutto il giorno
                    } else {
                        // Controlla permesso breve, es. "3,4,5"
                        // Aggiungiamo un filtro per NaN (es. se scrive "3,")
                        const absentHours = absenceValue.split(',')
                                                      .map(h => parseInt(h.trim(), 10))
                                                      .filter(h => !isNaN(h));
                        if (absentHours.includes(currentHour)) {
                            isAbsentThisHour = true;
                        }
                    }

                    if (isAbsentThisHour) {
                        const scheduleEntry = teacherSchedules[teacherName]?.[dayName]?.[hourIndex];
                        // Considera assente solo se ha una lezione (non "ora disposizione")
                        if (scheduleEntry && !scheduleEntry.toLowerCase().includes('ora disposizione')) {
                            const parts = scheduleEntry.split(' - ');
                            const absentClass = parts[0]?.trim();
                            const absentSubject = parts[1]?.trim().replace('.', '');
                            absentTeachersThisHour.push({ name: teacherName, class: absentClass, subject: absentSubject, fullEntry: scheduleEntry });
                        }
                    }
                }

                // 2. Trova docenti a disposizione in quest'ora
                const availableNow = getAvailableTeachers(hourIndex, dayName, allPresentTeachers);
                
                // 2.5 Trova docenti "spezzabili" da compresenze
                const breakableCoTeachers = findBreakableCoTeachers(hourIndex, dayName, allPresentTeachers);
                
                // Crea il datalist per i suggerimenti
                const dataListId = `dl-${dayName}-${hourIndex}`;
                let dataListHtml = `<datalist id="${dataListId}">`;
                if (breakableCoTeachers.length > 0) {
                    dataListHtml += `<optgroup label="Spezzando Compresenza">`;
                    for (const coTeacher of breakableCoTeachers) {
                        dataListHtml += `<option value="${coTeacher.name} (da ${coTeacher.fromClass} con ${coTeacher.with})"></option>`;
                    }
                    dataListHtml += `</optgroup>`;
                }
                // Aggiungiamo anche i docenti a disposizione "normali" ai suggerimenti
                if (availableNow.length > 0) {
                     dataListHtml += `<optgroup label="A Disposizione">`;
                    for (const available of availableNow) {
                         dataListHtml += `<option value="${available}"></option>`;
                    }
                     dataListHtml += `</optgroup>`;
                }
                dataListHtml += "</datalist>";


                // 3. Costruisci le righe della tabella
                if (absentTeachersThisHour.length === 0) {
                    // Nessun assente, mostra solo l'ora e chi è a disposizione
                    const availableStr = availableNow.length > 0 ? availableNow.join(', ') : '<em class="text-gray-400">Nessuno</em>';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3 text-sm font-medium text-gray-900">${hourLabel}</td>
                        <td class="p-3 text-sm text-gray-500 italic">/</td>
                        <td class="p-3 text-sm text-gray-500 italic">/</td>
                        <td class="p-3 text-sm text-gray-700">${availableStr} ${dataListHtml}</td> <!-- Aggiunto datalist anche qui -->
                        <td class="p-3 text-sm text-gray-500 italic">Docenti a Disp.</td>
                    `;
                    dailyTbody.appendChild(tr);
                } else {
                    // Ci sono uno o più assenti
                    for (let i = 0; i < absentTeachersThisHour.length; i++) {
                        const absentee = absentTeachersThisHour[i];
                        const { name, class: absentClass, subject: absentSubject, fullEntry } = absentee;
                        
                        let substituteResult = null;

                        // Priorità 0: Controllo Compresenza (colore Giallo)
                        let isCoPresence = false;
                        const classScheduleEntry = classSchedules[absentClass]?.[dayName]?.[hourIndex];
                        
                        if (classScheduleEntry && classScheduleEntry.includes(' / ')) {
                            const teachersInClass = classScheduleEntry.split(' / ').map(entry => entry.split(' - ')[1]?.trim());
                            const otherTeacherPresent = teachersInClass.find(tName => {
                                if (!tName || tName === name) return false; // Non controllare se stesso
                                return allPresentTeachers.includes(tName); // Controlla se l'altro docente è nell'elenco dei presenti
                            });

                            if (otherTeacherPresent) {
                                isCoPresence = true;
                                substituteResult = { substitute: `(${otherTeacherPresent})`, reason: "Copertura in Compresenza", color: "bg-yellow-50", textColor: "text-gray-900" };
                            }
                        }
                        
                        // Priorità 1-3: Ricerca Sostituto
                        if (!isCoPresence) {
                            substituteResult = findSubstitute(absentee, absentClass, absentSubject, availableNow);
                        }
                        
                        // Renderizza la riga
                        const tr = document.createElement('tr');
                        tr.className = substituteResult.color;
                        
                        const tdHour = document.createElement('td');
                        tdHour.className = `p-3 text-sm font-medium ${substituteResult.textColor}`;
                        tdHour.innerHTML = i === 0 ? hourLabel : '';
                        
                        const tdAbsent = document.createElement('td');
                        tdAbsent.className = `p-3 text-sm font-semibold text-red-700`;
                        tdAbsent.textContent = name;
                        
                        const tdClass = document.createElement('td');
                        tdClass.className = `p-3 text-sm text-red-700`;
                        tdClass.textContent = fullEntry;

                        // --- Cella Sostituto (Modificabile) ---
                        const tdSub = document.createElement('td');
                        tdSub.className = `p-0`; // Padding zero per far riempire l'input
                        const subInput = document.createElement('input');
                        subInput.type = 'text';
                        subInput.className = `sub-input ${substituteResult.color}`;
                        subInput.value = substituteResult.substitute;
                        subInput.setAttribute('list', dataListId); // Collega al datalist
                        // Aggiunge il datalist (nascosto) a questa cella
                        subInput.insertAdjacentHTML('afterend', dataListHtml); 
                        tdSub.appendChild(subInput);

                        // --- Cella Motivazione (Modificabile) ---
                        const tdReason = document.createElement('td');
                        tdReason.className = `p-0`;
                        const reasonInput = document.createElement('input');
                        reasonInput.type = 'text';
                        reasonInput.className = `sub-input ${substituteResult.color}`;
                        reasonInput.value = substituteResult.reason;
                        tdReason.appendChild(reasonInput);

                        // Funzione per cambiare colore in "Manuale" (Viola)
                        const setManualOverride = () => {
                            subInput.className = `sub-input bg-purple-50`;
                            reasonInput.className = `sub-input bg-purple-50`;
                            tr.className = `bg-purple-50`; // Cambia colore anche alla riga
                            if (reasonInput.value === substituteResult.reason) {
                                reasonInput.value = "Modifica Manuale";
                            }
                        };
                        
                        subInput.addEventListener('input', setManualOverride);
                        reasonInput.addEventListener('input', setManualOverride);

                        tr.appendChild(tdHour);
                        tr.appendChild(tdAbsent);
                        tr.appendChild(tdClass);
                        tr.appendChild(tdSub);
                        tr.appendChild(tdReason);
                        
                        dailyTbody.appendChild(tr);
                    }
                }
            }
        }

    </script>
</body>
</html>




