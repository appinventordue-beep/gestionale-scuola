<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Assenze Docenti</title>
    <!-- Importa Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importa la font Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        /* Stile base con la font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Stili per la tabella "sticky header" */
        .table-container {
            max-height: 60vh; /* Altezza massima per la tabella settimanale */
            overflow-y: auto;
        }
        .daily-table-container {
            max-height: 70vh; /* Altezza massima per la tabella giornaliera */
            overflow-y: auto;
        }
        th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Nasconde la freccia standard dei checkbox */
        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0.25rem; /* rounded */
            border-width: 1px;
            border-color: #cbd5e0; /* gray-400 */
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            cursor: pointer;
            vertical-align: middle;
            position: relative;
        }
        /* Stile personalizzato per il checkbox "checked" */
        input[type="checkbox"]:checked {
            background-color: #dc2626; /* red-600 */
            border-color: #dc2626; /* red-600 */
        }
        /* Aggiunge la "A" di Assente al checkbox */
        input[type="checkbox"]:checked::after {
            content: 'A';
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* Colori di sfondo per la motivazione */
        .bg-yellow-50 { background-color: #fffbeb; } /* Giallo Chiaro per Compresenza */
        .bg-blue-50 { background-color: #eff6ff; } /* Azzurro Chiaro per Docente Classe */
        .bg-orange-50 { background-color: #fff7ed; } /* Arancione Chiaro per Stessa Materia */
        .bg-green-50 { background-color: #f0fdf4; } /* Verde Chiaro per Disponibilità */
        .bg-red-50 { background-color: #fef2f2; } /* Rosso Chiaro per Non Trovato */
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div id="app-container" class="max-w-7xl mx-auto">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestionale Assenze Docenti</h1>

        <!-- Sezione di Caricamento File -->
        <div id="uploader-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <label for="csv-uploader" class="block text-lg font-semibold text-gray-700 mb-3">
                1. Carica i file CSV (Docenti e Classi)
            </label>
            <p class="text-sm text-gray-500 mb-4">Seleziona tutti i file <code>orario_doc...csv</code> e <code>orario_cla...csv</code>. I dati verranno elaborati localmente.</p>
            <input type="file" id="csv-uploader" multiple accept=".csv" 
                   class="block w-full text-sm text-gray-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-lg file:border-0
                          file:text-sm file:font-semibold
                          file:bg-blue-50 file:text-blue-700
                          hover:file:bg-blue-100 cursor-pointer">
            <div id="loading-spinner" class="hidden mt-4">
                <p class="text-blue-600 animate-pulse">Caricamento e elaborazione orari...</p>
            </div>
        </div>

        <!-- Vista Settimanale ("Foglio Settimana") -->
        <div id="weekly-view" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800">2. Pianificazione Settimanale Assenze</h2>
                <p class="text-sm text-gray-500 mt-2">
                    Seleziona le caselle per segnare un docente come "Assente" in un dato giorno. 
                    <br>
                    Clicca sull'intestazione del giorno (es. "Lun") per generare il foglio sostituzioni per quel giorno.
                </p>
            </div>
            <div class="table-container">
                <table id="weekly-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Docente</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Lun">Lunedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Mar">Martedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Mer">Mercoledì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Gio">Giovedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Ven">Venerdì</th>
                            <!-- Sabato è escluso come da richiesta implicita (Lun-Ven) -->
                        </tr>
                    </thead>
                    <tbody id="weekly-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Righe generate da JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vista Giornaliera ("Foglio Giorno") -->
        <div id="daily-view" class="hidden mt-12 bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="daily-view-title" class="text-2xl font-semibold text-gray-800">Gestione Sostituzioni</h2>
                <button id="back-to-week" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                    &larr; Torna alla Settimana
                </button>
            </div>
            <div class="daily-table-container">
                <table id="daily-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Ora</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Docente Assente</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Classe / Materia</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Sostituto Assegnato</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Motivazione</th>
                        </tr>
                    </thead>
                    <tbody id="daily-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Righe generate da JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Store globali per gli orari
        let teacherSchedules = {}; // Orari per docente (da orario_doc)
        let classSchedules = {};   // Orari per classe (da orario_cla)
        let classCouncils = {};     // Elenco docenti per classe (da orario_cla)
        let teacherSubjects = {};    // Elenco materie per docente (da orario_doc)

        // Mappa delle colonne dei giorni
        const dayColumnMap = { 'Lun': 1, 'Mar': 2, 'Mer': 3, 'Gio': 4, 'Ven': 5 };
        // Timeslot come da file (10 ore)
        const timeSlots = ["8.00", "8.50", "9.40", "10.30", "11.20", "12.10", "13.00", "13.50", "14.40", "15.30"];

        // Elementi DOM
        const csvUploader = document.getElementById('csv-uploader');
        const loadingSpinner = document.getElementById('loading-spinner');
        const weeklyView = document.getElementById('weekly-view');
        const dailyView = document.getElementById('daily-view');
        const weeklyTbody = document.getElementById('weekly-tbody');
        const dailyTbody = document.getElementById('daily-tbody');
        const dailyViewTitle = document.getElementById('daily-view-title');
        const backToWeekBtn = document.getElementById('back-to-week');

        // Event listener per il caricamento file
        csvUploader.addEventListener('change', handleFiles);

        // Event listener per il pulsante "Indietro"
        backToWeekBtn.addEventListener('click', () => {
            dailyView.classList.add('hidden');
            weeklyView.classList.remove('hidden');
            window.scrollTo(0, weeklyView.offsetTop);
        });

        /**
         * Gestisce i file CSV caricati dall'utente
         */
        function handleFiles(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            // Resetta gli store
            teacherSchedules = {};
            classSchedules = {};
            classCouncils = {};
            teacherSubjects = {};
            loadingSpinner.classList.remove('hidden');
            weeklyTbody.innerHTML = '';
            weeklyView.classList.add('hidden');
            dailyView.classList.add('hidden');

            const promises = [];

            for (const file of files) {
                const promise = new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const text = e.target.result;
                            if (file.name.includes('orario_doc')) {
                                parseTeacherSchedule(text, file.name);
                            } else if (file.name.includes('orario_cla')) {
                                parseClassSchedule(text, file.name);
                            } else {
                                console.warn(`File saltato: ${file.name} non è né un orario docente né un orario classe.`);
                            }
                            resolve();
                        } catch (error) {
                            console.error(`Errore nel processare il file ${file.name}:`, error);
                            reject(error);
                        }
                    };
                    reader.onerror = (e) => {
                        console.error(`Errore nel leggere il file ${file.name}:`, e);
                        reject(e);
                    }
                    reader.readAsText(file, 'ISO-8859-1'); // Usa encoding comune per file da Excel
                });
                promises.push(promise);
            }

            // Aspetta che tutti i file siano stati processati
            Promise.all(promises)
                .then(() => {
                    console.log('Orari docenti processati:', teacherSchedules);
                    console.log('Orari classi processati:', classSchedules);
                    console.log('Consigli di classe processati:', classCouncils);
                    console.log('Materie docenti processate:', teacherSubjects);
                    loadingSpinner.classList.add('hidden');
                    renderWeeklyTable();
                    weeklyView.classList.remove('hidden');
                })
                .catch((error) => {
                    console.error("Errore durante il processamento dei file:", error);
                    loadingSpinner.classList.add('hidden');
                    // Non usare alert()
                    console.error("Si è verificato un errore durante il caricamento di alcuni file.");
                });
        }

        /**
         * Esegue il parsing del contenuto CSV di un singolo orario docente
         */
        function parseTeacherSchedule(csvText, fileName) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 11) {
                console.warn(`File CSV docente saltato (${fileName}): numero di righe insufficiente.`);
                return;
            }

            // Estrae il nome del docente
            const teacherName = lines[0].split(',')[0].trim();
            if (!teacherName) {
                console.warn(`File CSV docente saltato (${fileName}): impossibile trovare il nome del docente.`);
                return;
            }
            
            teacherSubjects[teacherName] = new Set();
            const schedule = { "Lun": [], "Mar": [], "Mer": [], "Gio": [], "Ven": [] };

            // Processa le 10 righe degli orari
            for (let i = 1; i <= 10; i++) {
                const parts = lines[i].split(',');
                if (parts.length >= 6) { 
                    for (const day of Object.keys(dayColumnMap)) {
                        const scheduleEntry = parts[dayColumnMap[day]]?.trim() || '';
                        schedule[day].push(scheduleEntry);

                        // Popola l'elenco delle materie insegnate dal docente
                        if (scheduleEntry && !scheduleEntry.toLowerCase().includes('ora disposizione')) {
                            const subjectMatch = scheduleEntry.split(' - ')[1];
                            if (subjectMatch) {
                                teacherSubjects[teacherName].add(subjectMatch.trim().replace('.', '')); // Pulisce es. "STO."
                            }
                        }
                    }
                }
            }
            teacherSchedules[teacherName] = schedule;
        }

        /**
         * Esegue il parsing del contenuto CSV di un singolo orario classe
         */
        function parseClassSchedule(csvText, fileName) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 11) {
                console.warn(`File CSV classe saltato (${fileName}): numero di righe insufficiente.`);
                return;
            }

            const className = lines[0].split(',')[0].trim();
            if (!className) {
                console.warn(`File CSV classe saltato (${fileName}): impossibile trovare il nome della classe.`);
                return;
            }
            
            const schedule = { "Lun": [], "Mar": [], "Mer": [], "Gio": [], "Ven": [] };
            const council = new Set();

            for (let i = 1; i <= 10; i++) { // Itera le 10 ore
                const parts = lines[i].split(',');
                if (parts.length >= 6) {
                    for (const day of Object.keys(dayColumnMap)) {
                        const scheduleEntry = parts[dayColumnMap[day]]?.trim() || '';
                        schedule[day].push(scheduleEntry);
                        
                        // Aggiungi docenti al consiglio di classe
                        if (scheduleEntry) {
                            // Gestisce compresenze (es. "MAT - ROSSI / FIS - BIANCHI")
                            const entries = scheduleEntry.split(' / ');
                            for (const entry of entries) {
                                const teacherMatch = entry.split(' - ')[1];
                                if (teacherMatch) {
                                    council.add(teacherMatch.trim());
                                }
                            }
                        }
                    }
                }
            }
            classSchedules[className] = schedule;
            classCouncils[className] = council;
        }


        /**
         * Renderizza la tabella settimanale ("Foglio Settimana")
         */
        function renderWeeklyTable() {
            weeklyTbody.innerHTML = ''; // Pulisce la tabella
            const teacherNames = Object.keys(teacherSchedules).sort();

            if (teacherNames.length === 0) {
                weeklyTbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Nessun orario docente caricato o valido.</td></tr>';
                return;
            }

            for (const teacherName of teacherNames) {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-50');
                tr.innerHTML = `<td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${teacherName}</td>`;
                for (const day of Object.keys(dayColumnMap)) {
                    const td = document.createElement('td');
                    td.classList.add('p-3', 'text-center');
                    td.innerHTML = `<input type="checkbox" class="absence-check" data-teacher="${teacherName}" data-day="${day}">`;
                    tr.appendChild(td);
                }
                weeklyTbody.appendChild(tr);
            }

            document.querySelectorAll('#weekly-table th[data-day]').forEach(th => {
                th.addEventListener('click', (e) => {
                    const dayName = e.currentTarget.dataset.day;
                    showDailyView(dayName);
                });
            });
        }

        /**
         * Filtra i docenti presenti e trova quelli a disposizione in una data ora
         */
        function getAvailableTeachers(hourIndex, dayName, allPresentTeachers) {
            return allPresentTeachers.filter(teacherName => {
                const scheduleEntry = teacherSchedules[teacherName]?.[dayName]?.[hourIndex];
                return scheduleEntry && scheduleEntry.toLowerCase().includes('ora disposizione');
            });
        }

        /**
         * Trova un sostituto seguendo le priorità
         * @param {object} absentee - Oggetto del docente assente
         * @param {string} absentClass - Classe scoperta
         * @param {string} absentSubject - Materia scoperta
         * @param {string[]} availableNow - Array di docenti a disposizione in quest'ora
         */
        function findSubstitute(absentee, absentClass, absentSubject, availableNow) {
            // Priorità 3 (Default) - Colore Verde
            let result = { 
                substitute: availableNow.length > 0 ? availableNow[0] : "NON TROVATO", 
                reason: availableNow.length > 0 ? "Disponibilità Generica" : "Nessun docente disponibile", 
                color: availableNow.length > 0 ? "bg-green-50" : "bg-red-50",
                textColor: availableNow.length > 0 ? "text-gray-900" : "text-red-900"
            };

            if (availableNow.length === 0) {
                return result;
            }

            // Priorità 2: Stessa Materia - Colore Arancione
            const absentTeacherSubjects = teacherSubjects[absentee.name] || new Set();
            if (absentSubject) {
                absentTeacherSubjects.add(absentSubject); // Assicura che la materia specifica sia inclusa
            }

            const subjectTeacher = availableNow.find(teacher => {
                const subSubjects = teacherSubjects[teacher] || new Set();
                for (const subject of subSubjects) {
                    if (absentTeacherSubjects.has(subject)) return true;
                }
                return false;
            });
            if (subjectTeacher) {
                result = { substitute: subjectTeacher, reason: "Stessa Materia", color: "bg-orange-50", textColor: "text-gray-900" };
            }

            // Priorità 1: Docente della Classe - Colore Azzurro
            const classCouncil = classCouncils[absentClass] || new Set();
            const classTeacher = availableNow.find(teacher => classCouncil.has(teacher));
            if (classTeacher) {
                result = { substitute: classTeacher, reason: "Docente della Classe", color: "bg-blue-50", textColor: "text-gray-900" };
            }
            
            return result;
        }

        /**
         * Mostra la vista giornaliera ("Foglio Giorno") per il giorno selezionato
         */
        function showDailyView(dayName) {
            const dayTitles = { Lun: "Lunedì", Mar: "Martedì", Mer: "Mercoledì", Gio: "Giovedì", Ven: "Venerdì" };
            
            dailyViewTitle.textContent = `Gestione Sostituzioni per ${dayTitles[dayName]}`;
            weeklyView.classList.add('hidden');
            dailyView.classList.remove('hidden');
            dailyTbody.innerHTML = ''; 
            window.scrollTo(0, 0); 

            // Trova tutti i docenti *presenti* oggi (non assenti)
            const allPresentTeachers = Object.keys(teacherSchedules).filter(teacherName => {
                const checkbox = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                return checkbox && !checkbox.checked;
            });

            // Itera attraverso le 10 ore
            for (let hourIndex = 0; hourIndex < timeSlots.length; hourIndex++) {
                const hourSlot = timeSlots[hourIndex];
                const hourLabel = `${hourIndex + 1}a Ora <span class="text-xs text-gray-400">(${hourSlot})</span>`;

                // 1. Trova docenti assenti CHE HANNO LEZIONE in quest'ora
                const absentTeachersThisHour = [];
                for (const teacherName in teacherSchedules) {
                    const checkbox = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                    if (checkbox && checkbox.checked) { // È assente
                        const scheduleEntry = teacherSchedules[teacherName][dayName][hourIndex];
                        // Considera assente solo se ha una lezione
                        if (scheduleEntry && !scheduleEntry.toLowerCase().includes('ora disposizione')) {
                            const parts = scheduleEntry.split(' - ');
                            const absentClass = parts[0]?.trim();
                            const absentSubject = parts[1]?.trim().replace('.', '');
                            absentTeachersThisHour.push({ name: teacherName, class: absentClass, subject: absentSubject, fullEntry: scheduleEntry });
                        }
                    }
                }

                // 2. Trova docenti a disposizione in quest'ora
                const availableNow = getAvailableTeachers(hourIndex, dayName, allPresentTeachers);
                
                // 3. Costruisci le righe della tabella
                if (absentTeachersThisHour.length === 0) {
                    // Nessun assente, mostra solo l'ora e chi è a disposizione
                    const availableStr = availableNow.length > 0 ? availableNow.join(', ') : '<em class="text-gray-400">Nessuno</em>';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3 text-sm font-medium text-gray-900">${hourLabel}</td>
                        <td class="p-3 text-sm text-gray-500 italic">/</td>
                        <td class="p-3 text-sm text-gray-500 italic">/</td>
                        <td class="p-3 text-sm text-gray-700">${availableStr}</td>
                        <td class="p-3 text-sm text-gray-500 italic">Docenti a Disp.</td>
                    `;
                    dailyTbody.appendChild(tr);
                } else {
                    // Ci sono uno o più assenti
                    for (let i = 0; i < absentTeachersThisHour.length; i++) {
                        const absentee = absentTeachersThisHour[i];
                        const { name, class: absentClass, subject: absentSubject, fullEntry } = absentee;
                        
                        let substituteResult = null;

                        // Priorità 0: Controllo Compresenza (colore Giallo)
                        let isCoPresence = false;
                        const classScheduleEntry = classSchedules[absentClass]?.[dayName]?.[hourIndex];
                        
                        if (classScheduleEntry && classScheduleEntry.includes(' / ')) {
                            const teachersInClass = classScheduleEntry.split(' / ').map(entry => entry.split(' - ')[1]?.trim());
                            const otherTeacherPresent = teachersInClass.find(tName => {
                                if (!tName || tName === name) return false; // Non controllare se stesso
                                return allPresentTeachers.includes(tName); // Controlla se l'altro docente è nell'elenco dei presenti
                            });

                            if (otherTeacherPresent) {
                                isCoPresence = true;
                                substituteResult = { substitute: `(${otherTeacherPresent})`, reason: "Copertura in Compresenza", color: "bg-yellow-50", textColor: "text-gray-900" };
                            }
                        }
                        
                        // Priorità 1-3: Ricerca Sostituto
                        if (!isCoPresence) {
                            substituteResult = findSubstitute(absentee, absentClass, absentSubject, availableNow);
                        }
                        
                        // Renderizza la riga
                        const tr = document.createElement('tr');
                        tr.className = substituteResult.color;
                        tr.innerHTML = `
                            <td class="p-3 text-sm font-medium ${substituteResult.textColor}">${i === 0 ? hourLabel : ''}</td>
                            <td class="p-3 text-sm font-semibold text-red-700">${name}</td>
                            <td class="p-3 text-sm text-red-700">${fullEntry}</td>
                            <td class="p-3 text-sm font-semibold ${substituteResult.substitute === 'NON TROVATO' ? 'text-red-700' : substituteResult.textColor}">${substituteResult.substitute}</td>
                            <td class="p-3 text-sm text-gray-600">${substituteResult.reason}</td>
                        `;
                        dailyTbody.appendChild(tr);
                    }
                }
            }
        }

    </script>
</body>
</html>

