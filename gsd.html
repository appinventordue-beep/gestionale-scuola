<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Assenze Docenti</title>
    <!-- Importa Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importa la font Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <style>
        /* Stile base con la font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Stili per la tabella "sticky header" */
        .table-container {
            max-height: 60vh; /* Altezza massima per la tabella settimanale */
            overflow-y: auto;
        }
        .daily-table-container {
            max-height: 70vh; /* Altezza massima per la tabella giornaliera */
            overflow-y: auto;
        }
        th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Input per permessi brevi (ex checkbox) */
        .absence-input {
            transition: all 0.2s ease;
        }
        .absence-input:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }

        /* Colori di sfondo per la motivazione */
        .bg-yellow-50 { background-color: #fffbeb; } /* Giallo Chiaro per Compresenza */
        .bg-blue-50 { background-color: #eff6ff; } /* Azzurro Chiaro per Docente Classe */
        .bg-orange-50 { background-color: #fff7ed; } /* Arancione Chiaro per Stessa Materia */
        .bg-green-50 { background-color: #f0fdf4; } /* Verde Chiaro per Disponibilità */
        .bg-red-50 { background-color: #fef2f2; } /* Rosso Chiaro per Non Trovato */
        .bg-purple-50 { background-color: #f3e8ff; } /* Viola Chiaro per Modifica Manuale (Tailwind purple-50) */

        /* Stile per gli input nelle tabelle */
        .sub-input {
            width: 100%;
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            border-width: 0;
            border-radius: 0.375rem; /* rounded-md */
            background-color: transparent;
            font-size: 0.875rem; /* text-sm */
        }
        .sub-input:focus {
            outline: 2px solid #3b82f6; /* focus:outline-blue-500 */
            background-color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div id="app-container" class="max-w-7xl mx-auto">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestionale Assenze Docenti</h1>

        <!-- Sezione di Stato e Caricamento (Modificata per localStorage) -->
        <div id="status-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div id="status-header" class="flex justify-between items-center">
                 <h2 id="status-title" class="text-lg font-semibold text-gray-700">
                    Stato Applicazione
                 </h2>
                 <!-- Pulsante per resettare gli orari, inizialmente nascosto -->
                 <button id="clear-schedules-btn" class="hidden bg-red-50 text-red-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-100 transition-colors">
                    Resetta e Ricarica Orari...
                 </button>
            </div>
            
            <!-- Messaggio di stato che guida l'utente -->
            <p id="status-message" class="text-sm text-gray-500 mt-3">Inizializzazione...</p>
            
            <!-- Uploader (ora nascosto di default) -->
            <div id="uploader-container" class="hidden mt-4">
                <p class="text-sm text-gray-500 mb-4">Seleziona tutti i file <code>.csv</code> degli orari. Verranno salvati nel browser per i prossimi accessi.</p>
                <input type="file" id="csv-uploader" multiple accept=".csv" 
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-lg file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100 cursor-pointer">
                <div id="loading-spinner" class="hidden mt-4">
                    <p class="text-blue-600 animate-pulse">Caricamento e elaborazione orari... (Potrebbe richiedere un momento)</p>
                </div>
            </div>
        </div>


        <!-- Vista Settimanale ("Foglio Settimana") -->
        <div id="weekly-view" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800">Pianificazione Settimanale Assenze</h2>
                <p class="text-sm text-gray-500 mt-2">
                    Inserisci **"A"** per assenza totale o le ore di permesso (es: **"3,4,5"**).
                    <br>
                    Clicca sull'intestazione del giorno (es. "Lunedì") per generare il foglio sostituzioni.
                </p>
            </div>
            <div class="table-container">
                <table id="weekly-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Docente</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Lun">Lunedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Mar">Martedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Mer">Mercoledì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Gio">Giovedì</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700" data-day="Ven">Venerdì</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Righe generate da JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vista Giornaliera ("Foglio Giorno") -->
        <div id="daily-view" class="hidden mt-12 bg-white rounded-lg shadow-md overflow-hidden">
             <div class="p-6 border-b border-gray-200 flex flex-wrap justify-between items-center gap-4">
                <h2 id="daily-view-title" class="text-2xl font-semibold text-gray-800">Gestione Sostituzioni</h2>
                 <div class="flex gap-2">
                     <!-- Pulsante Copia (con nuovo formato) -->
                     <button id="copy-table-btn" class="bg-green-600 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                         Copia Tabella per Foglio Elettronico
                     </button>
                     <button id="back-to-week" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                         &larr; Torna alla Settimana
                     </button>
                 </div>
            </div>
            <div class="daily-table-container">
                <table id="daily-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Ora</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Docente Assente</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Classe / Materia</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Sostituto Assegnato</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Motivazione</th>
                        </tr>
                    </thead>
                    <tbody id="daily-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Righe generate da JS -->
                    </tbody>
                </table>
                 <!-- Area di testo temporanea per il copia/incolla -->
                 <textarea id="clipboard-helper" class="absolute -left-full -top-full"></textarea>
            </div>
        </div>

    </div>

    <script>
        // Store globali per gli orari
        let teacherSchedules = {}; // Orari per docente (da orario_doc)
        let classSchedules = {};   // Orari per classe (da orario_cla)
        let classCouncils = {};     // Elenco docenti per classe (da orario_cla)
        let teacherSubjects = {};    // Elenco materie per docente (da orario_doc)
        
        // Chiave per il localStorage
        const LOCAL_STORAGE_KEY = 'gestioneAssenzeOrari';

        // Mappa delle colonne dei giorni
        const dayColumnMap = { 'Lun': 1, 'Mar': 2, 'Mer': 3, 'Gio': 4, 'Ven': 5 };
        const dayTitlesFull = { Lun: "Lunedì", Mar: "Martedì", Mer: "Mercoledì", Gio: "Giovedì", Ven: "Venerdì" }; // Per estrarre il nome giorno
        // Timeslot come da file (10 ore)
        const timeSlots = ["8.00", "8.50", "9.40", "10.30", "11.20", "12.10", "13.00", "13.50", "14.40", "15.30"];

        // --- INIZIO SEZIONE GESTIONE DOM ---
        
        // Elementi DOM (principali)
        const weeklyView = document.getElementById('weekly-view');
        const dailyView = document.getElementById('daily-view');
        const weeklyTbody = document.getElementById('weekly-tbody');
        const dailyTbody = document.getElementById('daily-tbody');
        const dailyViewTitle = document.getElementById('daily-view-title');
        const backToWeekBtn = document.getElementById('back-to-week');
        const copyTableBtn = document.getElementById('copy-table-btn'); 
        const clipboardHelper = document.getElementById('clipboard-helper'); 
        
        // Elementi DOM per Uploader e Stato
        const csvUploader = document.getElementById('csv-uploader');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusSection = document.getElementById('status-section');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const uploaderContainer = document.getElementById('uploader-container');
        const clearSchedulesBtn = document.getElementById('clear-schedules-btn');

        // Avvio dell'applicazione
        window.onload = () => {
             statusMessage.textContent = "Ricerca orari salvati nel browser...";
             loadSchedulesFromLocalStorage();
        };

        /**
         * Carica gli orari da localStorage
         */
        function loadSchedulesFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);

                if (savedData) {
                    console.log("Dati caricati da localStorage");
                    const data = JSON.parse(savedData);
                    teacherSchedules = data.teacherSchedules || {};
                    classSchedules = data.classSchedules || {};
                    classCouncils = data.classCouncils || {};
                    teacherSubjects = data.teacherSubjects || {};
                    statusTitle.textContent = "Orari Caricati";
                    statusMessage.textContent = "Orari caricati con successo dal browser. Puoi iniziare a pianificare le assenze.";
                    uploaderContainer.classList.add('hidden');
                    clearSchedulesBtn.classList.remove('hidden'); 
                    renderWeeklyTable();
                    weeklyView.classList.remove('hidden');

                } else {
                    console.log("Nessun orario trovato nel browser. Mostro l'uploader.");
                    statusTitle.textContent = "Benvenuto!";
                    statusMessage.textContent = "Nessun orario trovato. Per iniziare, carica i file CSV (docenti e classi). Verranno salvati automaticamente nel browser.";
                    uploaderContainer.classList.remove('hidden'); 
                    clearSchedulesBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error("Errore nel caricare i dati da localStorage:", error);
                statusMessage.textContent = `Errore di lettura dal browser: ${error.message}. Prova a ricaricare i file.`;
                statusMessage.classList.add("text-red-600", "font-semibold");
                uploaderContainer.classList.remove('hidden'); 
            }
        }

        /**
         * Salva gli orari processati su localStorage
         */
        function saveSchedulesToLocalStorage() {
            const dataToSave = {
                teacherSchedules,
                classSchedules,
                classCouncils,
                teacherSubjects,
                savedAt: new Date().toISOString() 
            };
            try {
                statusMessage.textContent = "Salvataggio orari nel browser...";
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
                console.log("Orari salvati con successo in localStorage!");
                statusMessage.textContent = "Orari salvati nel browser per i futuri accessi.";
                statusTitle.textContent = "Orari Caricati e Salvati";
                uploaderContainer.classList.add('hidden');
                clearSchedulesBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Errore nel salvataggio in localStorage:", error);
                statusMessage.textContent = `Errore nel salvataggio nel browser: ${error.message}`;
                statusMessage.classList.add("text-red-600", "font-semibold");
                 if (error.name === 'QuotaExceededError') {
                    statusMessage.textContent = "Errore: Spazio di salvataggio nel browser esaurito. Impossibile salvare gli orari.";
                 }
            }
        }

        /**
         * Resetta gli orari (elimina da localStorage e ricarica la pagina)
         */
        clearSchedulesBtn.addEventListener('click', () => {
            if (confirm("Sei sicuro di voler cancellare gli orari salvati? Dovrai ricaricare i file CSV.")) {
                statusMessage.textContent = "Eliminazione orari dal browser in corso...";
                statusMessage.classList.remove("text-red-600", "font-semibold");
                try {
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    console.log("Dati eliminati. Ricaricamento pagina.");
                    statusMessage.textContent = "Orari resettati. Ricaricamento in corso...";
                    location.reload(); 
                } catch (error) {
                    console.error("Errore nell'eliminazione da localStorage:", error);
                    statusMessage.textContent = `Errore durante il reset: ${error.message}`;
                    statusMessage.classList.add("text-red-600", "font-semibold");
                }
            }
        });

        // Event listener per il caricamento file
        csvUploader.addEventListener('change', handleFiles);

        // Event listener per il pulsante "Indietro"
        backToWeekBtn.addEventListener('click', () => {
            dailyView.classList.add('hidden');
            weeklyView.classList.remove('hidden');
            window.scrollTo(0, weeklyView.offsetTop);
        });
        
        // Event listener per il pulsante "Copia"
        copyTableBtn.addEventListener('click', copyDailyTableToClipboard); 

        /**
         * Gestisce i file CSV caricati dall'utente
         */
        function handleFiles(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            teacherSchedules = {}; classSchedules = {}; classCouncils = {}; teacherSubjects = {};
            loadingSpinner.classList.remove('hidden'); weeklyTbody.innerHTML = ''; weeklyView.classList.add('hidden'); dailyView.classList.add('hidden');
            statusMessage.textContent = "Elaborazione file CSV..."; 

            const promises = []; let docFilesCount = 0; let claFilesCount = 0;

            for (const file of files) {
                const promise = new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const text = e.target.result;
                            const lines = text.split(/\r?\n/);
                            if (lines.length < 2) { console.warn(`File saltato: ${file.name} corto/vuoto.`); resolve(); return; }
                            const firstLine = lines[0]; const namePart = firstLine.split(',')[0].trim();
                            if (!namePart) { console.warn(`File saltato: ${file.name} senza nome.`); resolve(); return; }
                            if (namePart.includes(' ')) { if (parseTeacherSchedule(text, file.name)) docFilesCount++; } 
                            else { if (parseClassSchedule(text, file.name)) claFilesCount++; }
                            resolve();
                        } catch (error) { console.error(`Errore ${file.name}:`, error); reject(error); }
                    };
                    reader.onerror = (e) => { console.error(`Errore lettura ${file.name}:`, e); reject(e); }
                    reader.readAsText(file); 
                });
                promises.push(promise);
            }

            Promise.all(promises).then(() => { 
                    console.log(`OK. Docenti: ${docFilesCount}, Classi: ${claFilesCount}`);
                    // console.log('Orari doc:', teacherSchedules); console.log('Orari cla:', classSchedules); 
                    // console.log('Consigli:', classCouncils); console.log('Materie:', teacherSubjects); // Commentato per pulizia log
                    loadingSpinner.classList.add('hidden');
                    if (docFilesCount === 0 || claFilesCount === 0) {
                         const errorMsg = `Errore: File docenti: ${docFilesCount}, classi: ${claFilesCount}. Necessari entrambi.`;
                         console.error(errorMsg); statusMessage.textContent = errorMsg + " Riprova."; statusMessage.classList.add("text-red-600", "font-semibold"); weeklyView.classList.add('hidden'); 
                    } else {
                         saveSchedulesToLocalStorage(); 
                         renderWeeklyTable(); weeklyView.classList.remove('hidden');
                    }
                }).catch((error) => {
                    console.error("Errore processamento:", error); loadingSpinner.classList.add('hidden');
                    statusMessage.textContent = `Errore: ${error.message}`; statusMessage.classList.add("text-red-600", "font-semibold");
                });
        }
        
        /**
         * Popola la tabella settimanale con i docenti
         */
        function renderWeeklyTable() {
            weeklyTbody.innerHTML = ''; 
            const sortedTeachers = Object.keys(teacherSchedules).sort();
            if (sortedTeachers.length === 0) { weeklyTbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Nessun docente.</td></tr>'; return; }

            document.querySelectorAll('#weekly-table th[data-day]').forEach(th => { th.addEventListener('click', () => showDailyView(th.dataset.day)); });

            for (const teacherName of sortedTeachers) {
                const tr = document.createElement('tr'); tr.classList.add('hover:bg-gray-50');
                tr.innerHTML = `<td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${teacherName}</td>`;
                for (const day of Object.keys(dayColumnMap)) {
                    const td = document.createElement('td'); td.classList.add('p-3', 'text-center');
                    td.innerHTML = `<input type="text" class="absence-input w-20 text-center border border-gray-300 rounded-md p-1 text-sm uppercase" data-teacher="${teacherName}" data-day="${day}" placeholder="A / 3,4">`;
                    tr.appendChild(td);
                } weeklyTbody.appendChild(tr);
            }
        }

        /**
         * Esegue il parsing del CSV di un docente
         */
        function parseTeacherSchedule(csvText, fileName) {
            const lines = csvText.split(/\r?\n/); const teacherName = lines[0].split(',')[0].trim();
            if (!teacherName || teacherName.length < 3) { console.warn(`Nome docente non valido ${fileName}: ${teacherName}`); return false; }
            teacherSchedules[teacherName] = {}; if (!teacherSubjects[teacherName]) { teacherSubjects[teacherName] = new Set(); }
            const days = Object.keys(dayColumnMap); 
            for (let i = 0; i < timeSlots.length; i++) {
                const lineIndex = i + 1; if (lineIndex >= lines.length) break;
                const cols = lines[lineIndex].split(',');
                for (const day of days) {
                    const colIndex = dayColumnMap[day]; if (colIndex >= cols.length) continue;
                    const entry = cols[colIndex].trim();
                    if (!teacherSchedules[teacherName][day]) teacherSchedules[teacherName][day] = [];
                    teacherSchedules[teacherName][day][i] = entry; 
                    if (entry && !entry.toLowerCase().includes('ora disposizione')) {
                        const subject = entry.split(' - ')[1]?.trim().replace('.', '');
                        if (subject) teacherSubjects[teacherName].add(subject);
                    }
                }
            } teacherSubjects[teacherName] = Array.from(teacherSubjects[teacherName]); return true;
        }

        /**
         * Esegue il parsing del CSV di una classe
         */
        function parseClassSchedule(csvText, fileName) {
            const lines = csvText.split(/\r?\n/); const className = lines[0].split(',')[0].trim();
            if (!className || className.length > 5) { console.warn(`Nome classe non valido ${fileName}: ${className}`); return false; }
            classSchedules[className] = {}; classCouncils[className] = new Set(); 
            const days = Object.keys(dayColumnMap); 
            for (let i = 0; i < timeSlots.length; i++) {
                const lineIndex = i + 1; if (lineIndex >= lines.length) break;
                const cols = lines[lineIndex].split(',');
                for (const day of days) {
                    const colIndex = dayColumnMap[day]; if (colIndex >= cols.length) continue;
                    const entry = cols[colIndex].trim();
                    if (!classSchedules[className][day]) classSchedules[className][day] = [];
                    classSchedules[className][day][i] = entry; 
                    if (entry) {
                        const teachers = entry.split(' / ').map(e => e.split(' - ')[1]?.trim()).filter(Boolean);
                        teachers.forEach(t => classCouncils[className].add(t));
                    }
                }
            } classCouncils[className] = Array.from(classCouncils[className]); return true;
        }

        /**
         * Filtra i docenti presenti e trova quelli a disposizione in una data ora
         */
        function getAvailableTeachers(hourIndex, dayName, allPresentTeachers) {
            const currentHour = hourIndex + 1; 
            return allPresentTeachers.filter(teacherName => {
                const scheduleEntry = teacherSchedules[teacherName]?.[dayName]?.[hourIndex];
                if (!scheduleEntry || !scheduleEntry.toLowerCase().includes('ora disposizione')) return false; 
                const input = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                const absenceValue = input?.value.trim().toUpperCase() || ''; 
                if (absenceValue === '') return true; 
                const absentHours = absenceValue.split(',').map(h => parseInt(h.trim(), 10)).filter(h => !isNaN(h));
                if (absentHours.includes(currentHour)) return false; 
                return true; 
            });
        }

        /**
         * Trova un sostituto seguendo la logica delle priorità
         */
        function findSubstitute(absentee, absentClass, absentSubject, availableTeachers) {
            const { name: absentTeacherName } = absentee;
            const classCouncil = classCouncils[absentClass] || [];
            const p1_substitute = availableTeachers.find(t => classCouncil.includes(t));
            if (p1_substitute) return { substitute: p1_substitute, reason: "Docente della Classe", color: "bg-blue-50", textColor: "text-gray-900" };
            const absentTeacherSubjects = teacherSubjects[absentTeacherName] || [];
            const p2_substitute = availableTeachers.find(t => (teacherSubjects[t] || []).some(subSubject => absentTeacherSubjects.includes(subSubject)));
            if (p2_substitute) return { substitute: p2_substitute, reason: "Stessa Materia", color: "bg-orange-50", textColor: "text-gray-900" };
            if (availableTeachers.length > 0) return { substitute: availableTeachers[0], reason: "Disponibilità Generica", color: "bg-green-50", textColor: "text-gray-900" };
            return { substitute: "NON TROVATO", reason: "Nessun docente disponibile", color: "bg-red-50", textColor: "text-red-700" };
        }
        
        /**
         * Trova docenti in compresenza che possono essere "spezzati"
         */
        function findBreakableCoTeachers(hourIndex, dayName, allPresentTeachers) {
            let options = [];
            for (const className in classSchedules) {
                const entry = classSchedules[className]?.[dayName]?.[hourIndex];
                if (entry && entry.includes(' / ')) {
                    const teachers = entry.split(' / ').map(e => e.split(' - ')[1]?.trim()).filter(Boolean);
                    if (teachers.length === 2 && allPresentTeachers.includes(teachers[0]) && allPresentTeachers.includes(teachers[1])) {
                        options.push({ name: teachers[0], fromClass: className, with: teachers[1] });
                        options.push({ name: teachers[1], fromClass: className, with: teachers[0] });
                    }
                }
            } return options;
        }

        /**
         * Mostra la vista giornaliera ("Foglio Giorno") per il giorno selezionato
         */
        function showDailyView(dayName) {
            dailyViewTitle.textContent = `Gestione Sostituzioni per ${dayTitlesFull[dayName]}`;
            weeklyView.classList.add('hidden'); dailyView.classList.remove('hidden'); dailyTbody.innerHTML = ''; 
            window.scrollTo(0, 0); 
            const allPresentTeachers = Object.keys(teacherSchedules).filter(teacherName => {
                const input = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                const absenceValue = input?.value.trim().toUpperCase() || '';
                return absenceValue !== 'A'; 
            });

            for (let hourIndex = 0; hourIndex < timeSlots.length; hourIndex++) {
                const hourSlot = timeSlots[hourIndex];
                const hourLabel = `${hourIndex + 1}a Ora <span class="text-xs text-gray-400">(${hourSlot})</span>`;
                const currentHour = hourIndex + 1; 
                const assignedSubsThisHour = []; 
                const absentTeachersThisHour = [];
                for (const teacherName in teacherSchedules) {
                    const input = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${dayName}"]`);
                    const absenceValue = input?.value.trim().toUpperCase() || '';
                    if (absenceValue === '') continue; 
                    let isAbsentThisHour = false;
                    if (absenceValue === 'A') isAbsentThisHour = true; 
                    else {
                        const absentHours = absenceValue.split(',').map(h => parseInt(h.trim(), 10)).filter(h => !isNaN(h));
                        if (absentHours.includes(currentHour)) isAbsentThisHour = true;
                    }
                    if (isAbsentThisHour) {
                        const scheduleEntry = teacherSchedules[teacherName]?.[dayName]?.[hourIndex];
                        if (scheduleEntry && !scheduleEntry.toLowerCase().includes('ora disposizione')) {
                            const parts = scheduleEntry.split(' - ');
                            absentTeachersThisHour.push({ name: teacherName, class: parts[0]?.trim(), subject: parts[1]?.trim().replace('.', ''), fullEntry: scheduleEntry });
                        }
                    }
                }
                const availableNow = getAvailableTeachers(hourIndex, dayName, allPresentTeachers);
                const breakableCoTeachers = findBreakableCoTeachers(hourIndex, dayName, allPresentTeachers);
                const dataListId = `dl-${dayName}-${hourIndex}`;
                let dataListHtml = `<datalist id="${dataListId}">`;
                if (breakableCoTeachers.length > 0) {
                    dataListHtml += `<optgroup label="Spezzando Compresenza">`;
                    const breakableNames = new Set();
                    breakableCoTeachers.forEach(coTeacher => {
                        if (!availableNow.includes(coTeacher.name) && !assignedSubsThisHour.includes(coTeacher.name)) { 
                           dataListHtml += `<option value="${coTeacher.name} (da ${coTeacher.fromClass} con ${coTeacher.with})"></option>`;
                           breakableNames.add(coTeacher.name);
                        }
                    }); dataListHtml += `</optgroup>`;
                }
                if (availableNow.length > 0) {
                     dataListHtml += `<optgroup label="A Disposizione">`;
                    availableNow.forEach(available => { if (!assignedSubsThisHour.includes(available)) dataListHtml += `<option value="${available}"></option>`; });
                     dataListHtml += `</optgroup>`;
                } dataListHtml += "</datalist>";

                if (absentTeachersThisHour.length === 0) {
                    const trulyAvailableNow = availableNow.filter(t => !assignedSubsThisHour.includes(t));
                    const displayAvailable = trulyAvailableNow.join(', ') || '<em class="text-gray-400">Nessuno (libero/già assegnato)</em>';
                    const tr = document.createElement('tr'); const tempTd = document.createElement('td'); tempTd.innerHTML = dataListHtml; 
                    tr.innerHTML = `<td class="p-3 text-sm font-medium text-gray-900">${hourLabel}</td><td class="p-3 text-sm text-gray-500 italic">/</td><td class="p-3 text-sm text-gray-500 italic">/</td><td class="p-3 text-sm text-gray-700">${displayAvailable}</td><td class="p-3 text-sm text-gray-500 italic">Docenti a Disp.</td>`;
                    if (tr.cells[3]) tr.cells[3].appendChild(tempTd.querySelector('datalist')); // Check if cell exists
                    dailyTbody.appendChild(tr);
                } else {
                    for (let i = 0; i < absentTeachersThisHour.length; i++) {
                        const absentee = absentTeachersThisHour[i];
                        const { name, class: absentClass, subject: absentSubject, fullEntry } = absentee;
                        let substituteResult = null; let isCoPresence = false;
                        const classScheduleEntry = classSchedules[absentClass]?.[dayName]?.[hourIndex];
                        if (classScheduleEntry && classScheduleEntry.includes(' / ')) {
                            const teachersInClass = classScheduleEntry.split(' / ').map(entry => entry.split(' - ')[1]?.trim());
                            const otherTeacherPresent = teachersInClass.find(tName => tName && tName !== name && allPresentTeachers.includes(tName) && !assignedSubsThisHour.includes(tName));
                            if (otherTeacherPresent) {
                                isCoPresence = true;
                                substituteResult = { substitute: `(${otherTeacherPresent})`, reason: "Copertura in Compresenza", color: "bg-yellow-50", textColor: "text-gray-900" };
                                assignedSubsThisHour.push(otherTeacherPresent); 
                            }
                        }
                        if (!isCoPresence) {
                            const trulyAvailableNow = availableNow.filter(t => !assignedSubsThisHour.includes(t));
                            substituteResult = findSubstitute(absentee, absentClass, absentSubject, trulyAvailableNow);
                            if (substituteResult.substitute !== "NON TROVATO") assignedSubsThisHour.push(substituteResult.substitute);
                        }
                        const tr = document.createElement('tr'); tr.className = substituteResult.color;
                        const tdHour = document.createElement('td'); tdHour.className = `p-3 text-sm font-medium ${substituteResult.textColor}`; tdHour.innerHTML = i === 0 ? hourLabel : ''; 
                        const tdAbsent = document.createElement('td'); tdAbsent.className = `p-3 text-sm font-semibold text-red-700`; tdAbsent.textContent = name;
                        const tdClass = document.createElement('td'); tdClass.className = `p-3 text-sm text-red-700`; tdClass.textContent = fullEntry;
                        const tdSub = document.createElement('td'); tdSub.className = `p-0 relative`; 
                        const subInput = document.createElement('input'); subInput.type = 'text'; subInput.className = `sub-input ${substituteResult.color}`; subInput.value = substituteResult.substitute; subInput.setAttribute('list', dataListId); 
                        tdSub.appendChild(subInput); tdSub.insertAdjacentHTML('beforeend', dataListHtml); 
                        const tdReason = document.createElement('td'); tdReason.className = `p-0`;
                        const reasonInput = document.createElement('input'); reasonInput.type = 'text'; reasonInput.className = `sub-input ${substituteResult.color}`; reasonInput.value = substituteResult.reason;
                        tdReason.appendChild(reasonInput);
                        const setManualOverride = () => {
                            const previousValue = subInput._previousValue || substituteResult.substitute; 
                            if (previousValue !== "NON TROVATO" && !previousValue.startsWith('(') && assignedSubsThisHour.includes(previousValue)) {
                                const index = assignedSubsThisHour.indexOf(previousValue); if (index > -1) { assignedSubsThisHour.splice(index, 1); console.log(`Rimosso ${previousValue} (override).`); }
                            }
                            subInput.className = `sub-input bg-purple-50`; reasonInput.className = `sub-input bg-purple-50`; tr.className = `bg-purple-50`; 
                            if (reasonInput.value === substituteResult.reason) reasonInput.value = "Modifica Manuale";
                            const newValue = subInput.value.trim().split(' ')[0]; // Prende solo il nome prima di "(da..."
                             if (newValue && newValue !== "NON TROVATO" && !newValue.startsWith('(') && teacherSchedules[newValue] && !assignedSubsThisHour.includes(newValue)) {
                                 assignedSubsThisHour.push(newValue); console.log(`Aggiunto ${newValue} (override).`);
                            } subInput._previousValue = newValue; 
                        };
                        subInput._previousValue = substituteResult.substitute; 
                        subInput.addEventListener('input', setManualOverride); reasonInput.addEventListener('input', setManualOverride);
                        tr.appendChild(tdHour); tr.appendChild(tdAbsent); tr.appendChild(tdClass); tr.appendChild(tdSub); tr.appendChild(tdReason);
                        dailyTbody.appendChild(tr);
                    }
                }
            }
        }
        
       /**
         * MODIFICATO: Copia la tabella nel formato Docenti Assenti x Ore
         */
        function copyDailyTableToClipboard() {
            const dailyTable = document.getElementById('daily-table');
            if (!dailyTable || Object.keys(teacherSchedules).length === 0) return;

            // Estrai il giorno corrente dal titolo
            const titleText = dailyViewTitle.textContent;
            let currentDayShort = '';
            for (const key in dayTitlesFull) {
                if (titleText.includes(dayTitlesFull[key])) {
                    currentDayShort = key;
                    break;
                }
            }
            if (!currentDayShort) { console.error("Impossibile determinare il giorno corrente dal titolo."); return; }

            let tsvData = '';
            const allTeachersSorted = Object.keys(teacherSchedules).sort();

            // *** 1. Identifica Docenti Assenti (o in permesso) per il giorno ***
            const absentTeachersToday = allTeachersSorted.filter(teacherName => {
                const weeklyInput = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${currentDayShort}"]`);
                return weeklyInput?.value.trim() !== ''; // È assente se l'input non è vuoto
            });

            if (absentTeachersToday.length === 0) {
                 // Usa una notifica meno invasiva dell'alert
                 copyTableBtn.textContent = 'Nessun Assente!';
                 setTimeout(() => { copyTableBtn.textContent = 'Copia Tabella per Foglio Elettronico'; }, 2000);
                 console.log("Nessun docente assente o in permesso oggi.");
                 return; // Non copiare nulla se non ci sono assenti
            }

            // *** 2. Genera Intestazione ***
            const hourHeaders = timeSlots.map((slot, index) => `${index + 1}a Ora (${slot})`);
            tsvData += "Docente Assente\t" + hourHeaders.join('\t') + '\n'; // Usa TAB

            // *** 3. Itera SOLO sui Docenti Assenti ***
            absentTeachersToday.forEach(teacherName => {
                tsvData += teacherName + '\t'; // Prima colonna: Nome docente assente
                const rowData = [];
                const weeklyInput = document.querySelector(`input[data-teacher="${teacherName}"][data-day="${currentDayShort}"]`);
                const absenceValue = weeklyInput?.value.trim().toUpperCase() || ''; // Non dovrebbe essere vuoto qui

                for (let hourIndex = 0; hourIndex < timeSlots.length; hourIndex++) {
                    const currentHour = hourIndex + 1;
                    let cellContent = ''; // Contenuto di default

                    // Controlla se è assente IN QUESTA ORA specifica
                    let isAbsentThisHour = false;
                    if (absenceValue === 'A') {
                        isAbsentThisHour = true;
                    } else if (absenceValue !== '') {
                        const absentHours = absenceValue.split(',').map(h => parseInt(h.trim(), 10)).filter(h => !isNaN(h));
                        if (absentHours.includes(currentHour)) {
                            isAbsentThisHour = true;
                        }
                    }

                    if (isAbsentThisHour) {
                        const scheduleEntry = teacherSchedules[teacherName]?.[currentDayShort]?.[hourIndex];
                        const isTeaching = scheduleEntry && !scheduleEntry.toLowerCase().includes('ora disposizione');

                        if (isTeaching) {
                            // Cerca il sostituto nella tabella giornaliera visualizzata
                            let substituteName = "ERR: Riga non trovata";
                            let substituteReason = "";
                            const dailyRows = dailyTbody.querySelectorAll('tr');
                            let foundRow = false;
                            
                            // Cerca la riga corrispondente all'ora e al docente assente
                             let currentProcessingHour = 0;
                             for(const row of dailyRows) {
                                  const hourCellHtml = row.cells[0]?.innerHTML || '';
                                  const match = hourCellHtml.match(/^(\d+)a Ora/);
                                  if (match) {
                                     currentProcessingHour = parseInt(match[1], 10);
                                  }
                                  // Se siamo nell'ora giusta E il docente assente corrisponde
                                  if(currentProcessingHour === currentHour) {
                                     const absentCell = row.cells[1];
                                     if (absentCell?.textContent.trim() === teacherName) {
                                         const subInput = row.cells[3]?.querySelector('input');
                                         const reasonInput = row.cells[4]?.querySelector('input');
                                         substituteName = subInput?.value.trim() || "N/D";
                                         substituteReason = reasonInput?.value.trim() || "N/D";
                                         foundRow = true;
                                         break; // Trovato, esci dal ciclo delle righe
                                     }
                                  }
                                  if (currentProcessingHour > currentHour) break; // Ottimizzazione: siamo andati oltre l'ora cercata
                             } // Fine ciclo righe


                            if (foundRow) {
                                 if (substituteName.startsWith('(')) { // Caso Compresenza
                                     cellContent = `Coperto da Compresenza ${substituteName}`;
                                 } else if (substituteName === "NON TROVATO") {
                                     cellContent = "NON SOSTITUITO";
                                 } else {
                                     cellContent = `SOSTITUITO DA: ${substituteName} (${substituteReason})`;
                                 }
                             } else {
                                 // Se non troviamo la riga, potrebbe essere un bug o un caso limite
                                 cellContent = "ASSENTE (Info Sostituzione Mancante)";
                             }

                        } else {
                            // Era assente ma era a disposizione o aveva ora libera
                            cellContent = "ASSENTE (D/Libero)";
                        }
                    } else {
                        // Non è assente in quest'ora (es. fine permesso breve)
                        cellContent = ""; // Cella vuota
                    }
                    // Aggiungi la cella alla riga (con escape per virgolette)
                     rowData.push(`"${cellContent.replace(/"/g, '""')}"`);
                } // Fine ciclo ore (colonne)
                tsvData += rowData.join('\t') + '\n'; // Completa la riga del docente assente
            }); // Fine ciclo docenti assenti


            // Copia negli appunti (stesso meccanismo di prima)
            try {
                clipboardHelper.value = tsvData;
                clipboardHelper.select();
                document.execCommand('copy');
                console.log('Tabella Docenti Assenti x Ore copiata negli appunti.');

                const originalText = copyTableBtn.textContent;
                copyTableBtn.textContent = 'Copiato!';
                copyTableBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                copyTableBtn.classList.add('bg-gray-500');
                setTimeout(() => {
                    copyTableBtn.textContent = originalText;
                    copyTableBtn.classList.remove('bg-gray-500');
                    copyTableBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }, 1500); 

            } catch (err) {
                console.error('Errore durante la copia:', err);
                 const originalText = copyTableBtn.textContent;
                 copyTableBtn.textContent = 'Errore Copia';
                 setTimeout(() => { copyTableBtn.textContent = originalText; }, 2000);
            }
            clipboardHelper.blur();
        }


    </script>
</body>
</html>

